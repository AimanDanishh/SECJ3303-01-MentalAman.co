<th:block th:fragment="content(modules, completedCount, inProgressCount, selectedModule, selectedLesson, showQuiz)">
    <!-- Load Lucide Icons if not already loaded in the main layout -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>if (typeof lucide !== 'undefined') lucide.createIcons();</script>

    <div class="p-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-slate-900 mb-2">Learning Modules</h1>
            <p class="text-slate-600">Access comprehensive mental health literacy content</p>
        </div>

        <!-- Achievement Toast (Flashes only after successful quiz POST/redirect) -->
        <div th:if="${achievement}" class="fixed top-4 right-4 bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-6 py-4 rounded-lg shadow-2xl z-50 animate-pulse transition-opacity duration-300">
            <p class="font-bold text-lg" th:text="${achievement}"></p>
            <p class="text-sm">You earned 100 points!</p>
        </div>

        <!-- Progress Overview (Replicates TSX stats) -->
        <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div>
                    <p class="text-slate-600 mb-2">Total Modules</p>
                    <p class="text-3xl font-bold text-slate-900" th:text="${totalModules}"></p>
                </div>
                <div>
                    <p class="text-slate-600 mb-2">Completed</p>
                    <p class="text-3xl font-bold text-green-600" th:text="${completedCount}"></p>
                </div>
                <div>
                    <p class="text-slate-600 mb-2">In Progress</p>
                    <p class="text-3xl font-bold text-blue-600" th:text="${inProgressCount}"></p>
                </div>
                <div>
                    <p class="text-slate-600 mb-2">Total Time</p>
                    <p class="text-3xl font-bold text-slate-900">5.5 Hours</p>
                </div>
            </div>
        </div>
        [Image of Model-View-Controller (MVC) architecture]

        <!-- Modules Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <div th:each="module : ${modules}">
                <a th:href="${module.isLocked()} ? '#' : @{/learning/module(moduleId=${module.id})}"
                   th:classappend="${module.isLocked()} ? 'opacity-60 pointer-events-none' : 'cursor-pointer hover:shadow-lg'"
                   class="block bg-white rounded-xl shadow-md border border-slate-200 transition-shadow">
                    
                    <div class="p-6">
                        <div class="flex items-start justify-between mb-2">
                            <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-0.5 text-sm font-medium text-slate-800" th:text="${module.category}"></span>
                            <div th:if="${module.isLocked()}">
                                <script>document.write('<i data-lucide="lock" class="w-4 h-4 text-slate-400"></i>');</script>
                            </div>
                            <div th:if="${module.isQuizPassed()}">
                                <script>document.write('<i data-lucide="trophy" class="w-5 h-5 text-yellow-500"></i>');</script>
                            </div>
                        </div>
                        
                        <h3 class="text-xl font-bold text-slate-900 flex items-start gap-2 mb-2">
                            <script>document.write('<i data-lucide="book-open" class="w-5 h-5 text-blue-600 flex-shrink-0 mt-1"></i>');</script>
                            <span th:text="${module.title}"></span>
                        </h3>
                        <p class="text-slate-600 mb-4" th:text="${module.description}"></p>

                        <div th:if="${!module.isLocked() and module.getProgress() > 0}" class="mb-4">
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-slate-600">Progress</span>
                                <span class="text-slate-900 font-medium" th:text="${module.progress} + '%'"></span>
                            </div>
                            <!-- Simple Tailwind progress bar replacement for Shadcn Progress component -->
                            <div class="w-full bg-slate-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full" th:style="'width: ' + ${module.progress} + '%'"></div>
                            </div>
                        </div>

                        <div class="flex items-center gap-4 text-sm text-slate-600 mb-4">
                            <div class="flex items-center gap-1">
                                <script>document.write('<i data-lucide="clock" class="w-4 h-4"></i>');</script>
                                <span th:text="${module.duration}"></span>
                            </div>
                            <div class="flex items-center gap-1">
                                <script>document.write('<i data-lucide="play-circle" class="w-4 h-4"></i>');</script>
                                <span th:text="${module.lessons.size() + ' lessons'}"></span>
                            </div>
                        </div>

                        <div th:if="${!module.isLocked()}">
                            <button class="w-full py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                                <script>document.write('<i data-lucide="play-circle" class="w-4 h-4"></i>');</script>
                                <span th:text="${module.progress > 0 ? 'Continue Learning' : 'Start Module'}"></span>
                            </button>
                        </div>
                        <div th:if="${module.isLocked()}">
                            <button class="w-full py-2 px-4 bg-slate-200 text-slate-500 rounded-lg cursor-not-allowed flex items-center justify-center gap-2">
                                <script>document.write('<i data-lucide="lock" class="w-4 h-4"></i>');</script>
                                <span>Complete previous modules</span>
                            </button>
                        </div>
                    </div>
                </a>
            </div>
        </div>

        <!-- Achievements -->
        <div class="bg-white rounded-xl shadow-lg border border-slate-200">
            <div class="p-6">
                <h3 class="text-xl font-semibold text-slate-900 flex items-center gap-2 mb-4 border-b pb-4">
                    <script>document.write('<i data-lucide="trophy" class="w-5 h-5 text-yellow-600"></i>');</script>
                    Your Achievements
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div th:each="module : ${modules}" th:if="${module.isQuizPassed()}" class="text-center p-4 bg-yellow-50 rounded-lg border-2 border-yellow-200">
                        <div class="text-3xl mb-2">üèÜ</div>
                        <p class="text-sm font-medium text-yellow-900" th:text="${module.title}"></p>
                        <span class="inline-flex items-center rounded-full bg-yellow-500 px-3 py-0.5 text-xs font-medium text-white mt-2">Completed</span>
                    </div>
                    <!-- Placeholder for locked achievements (simplified) -->
                    <div th:if="${completedCount < 4}" th:each="i : ${#numbers.sequence(1, 4 - completedCount)}" class="text-center p-4 bg-slate-50 rounded-lg border-2 border-slate-200 opacity-50">
                        <div class="text-3xl mb-2">üîí</div>
                        <p class="text-sm font-medium text-slate-600">Locked Module</p>
                        <span class="inline-flex items-center rounded-full bg-slate-400 px-3 py-0.5 text-xs font-medium text-white mt-2">Locked</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Module View Modal (Replaces React Modal) -->
    <!-- The presence of 'selectedModule' in the Model controls whether this modal is shown -->
    <div th:if="${selectedModule != null}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40 overflow-y-auto">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-slate-200 p-6 flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900" th:text="${selectedModule.title}"></h2>
                    <p class="text-slate-600" th:text="${selectedModule.description}"></p>
                </div>
                <!-- Close Button redirects back to the main learning grid -->
                <a th:href="@{/learning}" class="text-slate-400 hover:text-slate-600">
                    <script>document.write('<i data-lucide="x" class="w-6 h-6"></i>');</script>
                </a>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">
                <!-- Lesson List (Left Panel) -->
                <div class="lg:col-span-1">
                    <h3 class="font-semibold text-slate-900 mb-4">Lessons</h3>
                    <div class="space-y-2">
                        <!-- Lesson Buttons -->
                        <a th:each="lesson, lessonStat : ${selectedModule.lessons}" 
                           th:href="@{/learning/module(moduleId=${selectedModule.id}, lessonId=${lesson.id})}"
                           th:classappend="${selectedLesson != null and selectedLesson.id == lesson.id} 
                                ? 'bg-blue-50 border-2 border-blue-500' 
                                : 'bg-slate-50 border-2 border-transparent hover:bg-slate-100'"
                           class="w-full p-3 rounded-lg text-left transition-colors flex flex-col">
                            
                            <div class="flex items-center justify-between mb-1">
                                <span class="font-medium text-slate-900 text-sm">
                                    <span th:text="${lessonStat.index + 1} + '. ' + ${lesson.title}"></span>
                                </span>
                                <div th:if="${lesson.isCompleted()}">
                                    <script>document.write('<i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>');</script>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 text-xs text-slate-600">
                                <div th:if="${lesson.type == 'video'}"><script>document.write('<i data-lucide="play-circle" class="w-3 h-3"></i>');</script></div>
                                <div th:if="${lesson.type == 'infographic'}"><script>document.write('<i data-lucide="image" class="w-3 h-3"></i>');</script></div>
                                <span th:text="${lesson.duration}"></span>
                            </div>
                        </a>
                        
                        <!-- Quiz Button (Opens the Quiz view state) -->
                        <a th:if="${selectedModule.quiz.size() > 0}"
                           th:href="@{/learning/module(moduleId=${selectedModule.id}, showQuiz=true)}"
                           class="w-full p-3 rounded-lg text-left bg-purple-50 border-2 border-purple-200 hover:bg-purple-100 transition-colors flex flex-col">
                            <div class="flex items-center justify-between mb-1">
                                <span class="font-medium text-purple-900 text-sm">üìù Module Quiz</span>
                                <div th:if="${selectedModule.isQuizPassed()}">
                                    <span class="inline-flex items-center rounded-full bg-green-500 px-2 py-0.5 text-xs font-medium text-white">Passed</span>
                                </div>
                            </div>
                            <p class="text-xs text-purple-700" th:text="${selectedModule.quiz.size() + ' questions'}"></p>
                        </a>
                    </div>
                </div>

                <!-- Content Area (Right Panel) -->
                <div class="lg:col-span-2">
                    <!-- Lesson Content View -->
                    <div th:if="${!showQuiz and selectedLesson != null}">
                        <h3 class="text-xl font-bold text-slate-900 mb-4" th:text="${selectedLesson.title}"></h3>

                        <!-- Video Content -->
                        <div th:if="${selectedLesson.type == 'video'}" class="mb-4">
                            <div class="aspect-video bg-slate-900 rounded-lg overflow-hidden mb-4">
                                <iframe th:src="${selectedLesson.url}" class="w-full h-full"
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                        allowFullScreen>
                                </iframe>
                            </div>
                            <p class="text-slate-600 mb-4" th:text="'Watch this video to learn about ' + ${#strings.toLowerCase(selectedLesson.title)} + '.'"></p>
                        </div>

                        <!-- Infographic Content -->
                        <div th:if="${selectedLesson.type == 'infographic'}" class="mb-4">
                            <img th:src="${selectedLesson.url}" th:alt="${selectedLesson.title}"
                                 class="w-full rounded-lg shadow-lg mb-4"/>
                            <p class="text-slate-600 mb-4" th:text="'Study this infographic to understand ' + ${#strings.toLowerCase(selectedLesson.title)} + '.'"></p>
                        </div>

                        <!-- Complete Lesson Form/Button (POST back to controller) -->
                        <form th:action="@{/learning/complete-lesson}" method="post">
                            <input type="hidden" name="moduleId" th:value="${selectedModule.id}" />
                            <input type="hidden" name="lessonId" th:value="${selectedLesson.id}" />
                            <button type="submit" th:disabled="${selectedLesson.isCompleted()}"
                                    th:classappend="${selectedLesson.isCompleted()} 
                                        ? 'bg-green-100 text-green-700 cursor-not-allowed' 
                                        : 'bg-blue-600 text-white hover:bg-blue-700'"
                                    class="w-full py-3 px-4 rounded-lg font-medium transition-colors">
                                <span th:if="${selectedLesson.isCompleted()}" class="flex items-center justify-center gap-2">
                                    <script>document.write('<i data-lucide="check-circle" class="w-5 h-5"></i>');</script>
                                    Completed
                                </span>
                                <span th:unless="${selectedLesson.isCompleted()}">Mark as Complete</span>
                            </button>
                        </form>
                    </div>

                    <!-- Quiz Content View -->
                    <div th:if="${showQuiz and selectedModule.quiz.size() > 0}">
                        <h3 class="text-xl font-bold text-slate-900 mb-2">Module Quiz</h3>
                        <p class="text-slate-600 mb-6">Answer all questions correctly (70% minimum) to complete this module.</p>
                        
                        <!-- Quiz Result Display (Thymeleaf Flash Attribute) -->
                        <div th:if="${quizScore != null}" class="text-center py-8">
                            <div th:classappend="${quizScore >= 70} ? 'bg-green-100' : 'bg-red-100'"
                                 class="w-32 h-32 rounded-full mx-auto mb-4 flex items-center justify-center text-4xl">
                                <span th:text="${quizScore >= 70} ? 'üéâ' : 'üòî'"></span>
                            </div>
                            <h4 class="text-2xl font-bold text-slate-900 mb-2">Score: <span th:text="${quizScore} + '%'"></span></h4>
                            <p class="text-slate-600 mb-6" th:text="${quizScore >= 70} 
                                ? 'Congratulations! You passed the quiz!' 
                                : 'You need 70% to pass. Try again!'"></p>
                            
                            <!-- Retake/Continue Buttons -->
                            <div class="flex justify-center gap-4">
                                <a th:if="${quizScore < 70}" th:href="@{/learning/module(moduleId=${selectedModule.id}, showQuiz=true)}"
                                   class="py-2 px-6 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Retake Quiz</a>
                                
                                <a th:if="${quizScore >= 70}" th:href="@{/learning}"
                                   class="py-2 px-6 bg-green-600 text-white rounded-lg hover:bg-green-700">Continue Learning</a>
                            </div>
                        </div>

                        <!-- Quiz Form -->
                        <form th:unless="${quizScore != null}" th:action="@{/learning/submit-quiz}" method="post">
                            <input type="hidden" name="moduleId" th:value="${selectedModule.id}" />
                            <div class="space-y-6">
                                <div th:each="question, qStat : ${selectedModule.quiz}" class="p-4 bg-slate-50 rounded-lg">
                                    <p class="font-medium text-slate-900 mb-4" th:text="${qStat.index + 1} + '. ' + ${question.question}"></p>
                                    <div class="space-y-2">
                                        <label th:each="option, oStat : ${question.options}"
                                               class="flex items-center p-3 rounded-lg border-2 cursor-pointer transition-colors border-slate-200 hover:border-slate-300">
                                            <input type="radio" 
                                                   th:name="'question-' + ${question.id}" 
                                                   th:value="${oStat.index}" 
                                                   required 
                                                   class="w-4 h-4 text-blue-600" />
                                            <span class="ml-3 text-slate-900" th:text="${option}"></span>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Submit Quiz Button -->
                                <button type="submit"
                                   class="w-full py-3 px-4 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition-colors">
                                    Submit Quiz
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Re-initialize Lucide Icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    </script>
</th:block>