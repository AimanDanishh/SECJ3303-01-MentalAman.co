<th:block th:fragment="content(modules, completedCount, inProgressCount, totalModules, selectedModule, selectedLesson, showQuiz, quizScore, lessons, quizQuestions, achievement, user, students, referrals, reasons, selectedStudent, showForm, formData, showSuccess, showError, errorMessage)">

    <div class="max-w-[1600px] mx-auto px-6 py-6 h-[85vh] flex gap-6">

        <div class="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden relative">
            
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white z-10">
                <div class="flex items-center gap-3">
                    <div class="bg-purple-100 p-2 rounded-xl">
                        <i data-lucide="sparkles" class="w-5 h-5 text-purple-600"></i>
                    </div>
                    <div>
                        <h2 class="font-bold text-slate-800 text-base">AI Mental Health Coach</h2>
                        <p class="text-xs text-slate-500">Always here to listen</p>
                    </div>
                </div>
                <form th:action="@{/coach/clear}" method="post">
                    <button type="submit" class="text-xs font-bold text-slate-400 hover:text-red-500 flex items-center gap-1 transition-colors px-3 py-1.5 rounded-lg hover:bg-slate-50">
                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i> Clear Chat
                    </button>
                </form>
            </div>

            <div id="messages-container" class="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-50/30">
                
                <div id="empty-state" th:if="${messages == null or messages.empty}" class="flex flex-col items-center justify-center h-full text-center opacity-60">
                    <div class="bg-purple-50 p-4 rounded-full mb-3">
                        <i data-lucide="message-square" class="w-8 h-8 text-purple-400"></i>
                    </div>
                    <p class="text-slate-500 font-medium">No messages yet. Say "Hi" to start!</p>
                </div>

                <div th:each="message : ${messages}" 
                     th:classappend="${message.sender == 'user'} ? 'flex-row-reverse' : ''" 
                     class="flex items-start gap-3 animate-fade-in">
                    
                    <div th:classappend="${message.sender == 'ai'} ? 'bg-purple-600 text-white' : 'bg-slate-200 text-slate-600'"
                         class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 shadow-sm">
                        <i th:if="${message.sender == 'ai'}" data-lucide="bot" class="w-4 h-4"></i>
                        <i th:if="${message.sender == 'user'}" data-lucide="user" class="w-4 h-4"></i>
                    </div>

                    <div class="flex flex-col max-w-[80%]">
                        <div th:classappend="${message.sender == 'ai'} ? 'bg-white text-slate-700 rounded-tl-none border border-slate-200' : 'bg-blue-600 text-white rounded-tr-none shadow-md'"
                             class="px-5 py-3 rounded-2xl text-sm leading-relaxed shadow-sm">
                            <p th:text="${message.text}"></p>
                        </div>
                        <span th:text="${message.formattedTime}" 
                              th:classappend="${message.sender == 'user'} ? 'text-right' : ''"
                              class="text-[10px] text-slate-400 mt-1 px-1">Time</span>
                    </div>
                </div>
            </div>

            <div class="p-4 bg-white border-t border-slate-100">
                <form id="chat-form" class="relative flex items-center gap-2" onsubmit="handleChatSubmit(event)">
                    <input type="text" 
                           id="input-message" 
                           name="inputMessage" 
                           required 
                           autocomplete="off"
                           placeholder="Type your message here..."
                           class="w-full pl-5 pr-14 py-4 bg-slate-50 border border-slate-200 rounded-xl text-sm text-slate-700 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all shadow-inner">
                    
                    <button type="submit" 
                            class="absolute right-2 bg-purple-600 hover:bg-purple-700 text-white p-2.5 rounded-lg transition-all shadow-md hover:shadow-lg active:scale-95">
                        <i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                </form>
            </div>
        </div>

        <div class="hidden lg:flex flex-col w-[350px] gap-4 h-full overflow-y-auto pr-2 custom-scrollbar">
            
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
                <h3 class="font-bold text-slate-800 mb-4 text-sm">Quick Topics</h3>
                <div class="space-y-2">
                    <button onclick="fillInput('Exam Stress')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-slate-100 rounded-xl text-xs font-medium text-slate-700 flex items-center gap-3 transition-all"><span class="text-base">üìö</span> Exam Stress</button>
                    <button onclick="fillInput('Anxiety')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-slate-100 rounded-xl text-xs font-medium text-slate-700 flex items-center gap-3 transition-all"><span class="text-base">üò∞</span> Anxiety</button>
                    <button onclick="fillInput('Sleep Issues')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-slate-100 rounded-xl text-xs font-medium text-slate-700 flex items-center gap-3 transition-all"><span class="text-base">üò¥</span> Sleep Issues</button>
                    <button onclick="fillInput('Stress Management')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-slate-100 rounded-xl text-xs font-medium text-slate-700 flex items-center gap-3 transition-all"><span class="text-base">üßò</span> Stress Management</button>
                    <button onclick="fillInput('Loneliness')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-slate-100 rounded-xl text-xs font-medium text-slate-700 flex items-center gap-3 transition-all"><span class="text-base">üíî</span> Loneliness</button>
                    <button onclick="fillInput('Self-Care Tips')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-slate-100 rounded-xl text-xs font-medium text-slate-700 flex items-center gap-3 transition-all"><span class="text-base">‚ù§Ô∏è</span> Self-Care Tips</button>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
                <h3 class="font-bold text-slate-800 mb-4 text-sm">How AI Coach Works</h3>
                <div class="space-y-3">
                    <div class="flex items-start gap-3"><i data-lucide="check-circle-2" class="w-4 h-4 text-green-500 mt-0.5 flex-shrink-0"></i><p class="text-xs text-slate-600">24/7 availability for instant support</p></div>
                    <div class="flex items-start gap-3"><i data-lucide="check-circle-2" class="w-4 h-4 text-green-500 mt-0.5 flex-shrink-0"></i><p class="text-xs text-slate-600">Confidential and judgment-free</p></div>
                    <div class="flex items-start gap-3"><i data-lucide="check-circle-2" class="w-4 h-4 text-green-500 mt-0.5 flex-shrink-0"></i><p class="text-xs text-slate-600">Evidence-based coping strategies</p></div>
                    <div class="flex items-start gap-3"><i data-lucide="check-circle-2" class="w-4 h-4 text-green-500 mt-0.5 flex-shrink-0"></i><p class="text-xs text-slate-600">Chat history saved automatically</p></div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
                <div class="flex items-center gap-2 mb-3"><i data-lucide="alert-circle" class="w-5 h-5 text-orange-500"></i><h3 class="font-bold text-slate-800 text-sm">Important Note</h3></div>
                <p class="text-xs text-slate-600 leading-relaxed mb-4">The AI Coach provides general support and guidance, but is not a replacement for professional mental health care.</p>
                <a href="#" class="block w-full py-2.5 bg-[#a855f7] hover:bg-[#9333ea] text-white text-center rounded-lg text-xs font-bold transition-all shadow hover:shadow-md">Book Counselor Session</a>
            </div>

            <div class="bg-purple-50 border border-purple-100 rounded-2xl p-5 text-center shadow-sm">
                <div class="flex justify-center mb-3"><i data-lucide="heart" class="w-7 h-7 text-[#a855f7]"></i></div>
                <p class="text-slate-800 text-xs font-bold mb-1">Remember: Seeking support is a sign of strength, not weakness.</p>
            </div>
        </div>

    </div>

    <script th:inline="javascript">
        
        // 1. Handle Form Submit with AJAX
        async function handleChatSubmit(event) {
            event.preventDefault(); // STOP PAGE REFRESH
            
            const input = document.getElementById('input-message');
            const messageText = input.value.trim();
            if (!messageText) return;

            // Clear input and remove empty state
            input.value = '';
            const emptyState = document.getElementById('empty-state');
            if(emptyState) emptyState.remove();

            // A. Show USER Message Immediately (Optimistic UI)
            appendMessage(messageText, 'user', getCurrentTime());

            try {
                // B. Send to Backend
                const formData = new URLSearchParams();
                formData.append('inputMessage', messageText);

                const response = await fetch('/coach/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                if (response.ok) {
                    // C. Show AI Response when ready
                    const aiMessage = await response.json(); // Controller now returns JSON!
                    appendMessage(aiMessage.text, 'ai', aiMessage.formattedTime);
                }
            } catch (error) {
                console.error("Chat Error:", error);
                appendMessage("Sorry, I'm having trouble connecting right now.", 'ai', getCurrentTime());
            }
        }

        // 2. Helper to Append HTML Bubbles Dynamically
        function appendMessage(text, sender, time) {
            const container = document.getElementById('messages-container');
            const isUser = sender === 'user';
            
            const div = document.createElement('div');
            div.className = `flex items-start gap-3 animate-fade-in ${isUser ? 'flex-row-reverse' : ''}`;
            
            div.innerHTML = `
                <div class="${isUser ? 'bg-slate-200 text-slate-600' : 'bg-purple-600 text-white'} w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 shadow-sm">
                    <i data-lucide="${isUser ? 'user' : 'bot'}" class="w-4 h-4"></i>
                </div>
                <div class="flex flex-col max-w-[80%]">
                    <div class="${isUser ? 'bg-blue-600 text-white rounded-tr-none shadow-md' : 'bg-white text-slate-700 rounded-tl-none border border-slate-200'} px-5 py-3 rounded-2xl text-sm leading-relaxed shadow-sm">
                        <p>${text}</p>
                    </div>
                    <span class="text-[10px] text-slate-400 mt-1 px-1 ${isUser ? 'text-right' : ''}">${time}</span>
                </div>
            `;
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            if (typeof lucide !== "undefined") lucide.createIcons();
        }

        // 3. Helper for Quick Topics
        function fillInput(val) {
            const input = document.getElementById('input-message');
            input.value = val;
            document.getElementById('chat-form').requestSubmit(); // Triggers the handleChatSubmit function
        }

        // 4. Time Helper
        function getCurrentTime() {
            return new Date().toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        }

        // 5. Init
        document.addEventListener("DOMContentLoaded", function () {
            const container = document.getElementById("messages-container");
            if (container) container.scrollTop = container.scrollHeight;
            if (typeof lucide !== "undefined") lucide.createIcons();
        });
    </script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</th:block>