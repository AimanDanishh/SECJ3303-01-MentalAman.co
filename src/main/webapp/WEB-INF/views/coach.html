<th:block th:fragment="content(modules, completedCount, inProgressCount, totalModules, selectedModule, selectedLesson, showQuiz, quizScore, lessons, quizQuestions, achievement, user, messages)">
    
    <div class="w-full px-4">
        
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-slate-900 mb-2 flex items-center gap-3">
                <i data-lucide="sparkles" class="w-8 h-8 text-purple-600"></i>
                AI Mental Health Coach
            </h1>
            <p class="text-slate-600">Get instant support and guidance for your mental wellbeing</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
            
            <div class="lg:col-span-2 bg-white rounded-xl shadow-lg border border-slate-200 flex flex-col min-h-[70vh] overflow-hidden relative">
                
                <div class="p-4 border-b flex justify-between items-center bg-white z-10">
                    <div class="flex items-center gap-2">
                        <div class="bg-purple-100 p-1.5 rounded-lg">
                            <i data-lucide="bot" class="w-5 h-5 text-purple-600"></i>
                        </div>
                        <span class="font-semibold text-slate-700">Chat with AI Coach</span>
                    </div>
                    <form th:action="@{/coach/clear}" method="post">
                        <button type="submit" class="text-xs text-slate-500 hover:text-slate-800 flex items-center gap-1 px-3 py-1.5 rounded-md hover:bg-slate-100 transition-colors">
                            <i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i> Clear Chat
                        </button>
                    </form>
                </div>

                <div id="messages-container" class="flex-1 overflow-y-auto p-6 space-y-6 bg-white">
                    

                    <div th:each="message : ${messages}"
                         th:classappend="${message.role == 'user'} ? 'flex-row-reverse' : ''"
                         class="flex items-start gap-4">
                        
                        <div th:classappend="${message.role == 'ai'} ? 'bg-purple-100' : 'bg-slate-100'"
                             class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 border border-slate-100">
                            <i th:if="${message.role == 'ai'}" data-lucide="bot" class="w-5 h-5 text-purple-600"></i>
                            <i th:if="${message.role == 'user'}" data-lucide="user" class="w-5 h-5 text-slate-600"></i>
                        </div>
                        
                        <div th:classappend="${message.role == 'user'} ? 'items-end' : 'items-start'" class="flex flex-col max-w-[85%]">
                            <div th:classappend="${message.role == 'ai'} ? 'bg-slate-100 text-slate-800 rounded-tl-none' : 'bg-blue-600 text-white rounded-tr-none'"
                                 class="px-5 py-3.5 rounded-2xl text-[15px] leading-relaxed shadow-sm">
                                <p class="whitespace-pre-line" th:text="${message.text}"></p>
                            </div>
                            <span class="text-[11px] text-slate-400 mt-1.5 font-medium px-1">
                                <span th:text="${message.role == 'ai' ? 'AI Coach' : 'You'}"></span> ‚Ä¢ Just now
                            </span>
                        </div>
                    </div>

                    <div id="typing-indicator" class="hidden flex items-start gap-4">
                        <div class="bg-purple-100 w-10 h-10 rounded-full flex items-center justify-center border border-purple-50">
                            <i data-lucide="bot" class="w-5 h-5 text-purple-600"></i>
                        </div>
                        <div class="bg-slate-100 px-4 py-4 rounded-2xl rounded-tl-none">
                            <div class="flex gap-1.5">
                                <span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce"></span>
                                <span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce [animation-delay:0.2s]"></span>
                                <span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce [animation-delay:0.4s]"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-5 border-t bg-white z-20">
                    <form th:action="@{/coach/send}" method="post" id="chat-form" class="flex gap-3 relative">
                        <input type="text" id="input-message" name="inputMessage" required autocomplete="off"
                               placeholder="Type your message here... (Press Enter to send)"
                               class="flex-1 pl-4 pr-12 py-3.5 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none text-sm text-slate-700 placeholder-slate-400 transition-all shadow-sm">
                        
                        <button type="submit" id="send-btn" class="px-6 py-3.5 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl transition-colors flex items-center gap-2 font-semibold text-sm border border-slate-200">
                            <span>Send</span>
                            <i data-lucide="send" class="w-4 h-4"></i>
                        </button>
                    </form>
                </div>
                
            </div> 
            <div class="space-y-6">
                
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                    <h3 class="font-bold text-slate-800 mb-4 text-sm flex items-center gap-2">
                        Quick Topics
                    </h3>
                    <div class="space-y-2">
                        <button type="button" onclick="fillInput('Exam Stress')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-slate-100 border border-transparent hover:border-slate-200 rounded-lg text-xs font-medium text-slate-700 flex items-center gap-3 transition-all">
                            <span class="text-base">üìö</span> Exam Stress
                        </button>
                        <button type="button" onclick="fillInput('Anxiety')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-slate-100 border border-transparent hover:border-slate-200 rounded-lg text-xs font-medium text-slate-700 flex items-center gap-3 transition-all">
                            <span class="text-base">üò∞</span> Anxiety
                        </button>
                        <button type="button" onclick="fillInput('Sleep Issues')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-slate-100 border border-transparent hover:border-slate-200 rounded-lg text-xs font-medium text-slate-700 flex items-center gap-3 transition-all">
                            <span class="text-base">üò¥</span> Sleep Issues
                        </button>
                        <button type="button" onclick="fillInput('Stress Management')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-slate-100 border border-transparent hover:border-slate-200 rounded-lg text-xs font-medium text-slate-700 flex items-center gap-3 transition-all">
                            <span class="text-base">üßò</span> Stress Management
                        </button>
                        <button type="button" onclick="fillInput('Loneliness')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-slate-100 border border-transparent hover:border-slate-200 rounded-lg text-xs font-medium text-slate-700 flex items-center gap-3 transition-all">
                            <span class="text-base">üíî</span> Loneliness
                        </button>
                        <button type="button" onclick="fillInput('Self-Care Tips')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-slate-100 border border-transparent hover:border-slate-200 rounded-lg text-xs font-medium text-slate-700 flex items-center gap-3 transition-all">
                            <span class="text-base">‚ù§Ô∏è</span> Self-Care Tips
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                    <h3 class="font-bold text-slate-800 mb-4 text-sm flex items-center gap-2">
                        How AI Coach Works
                    </h3>
                    <div class="space-y-4">
                        <div class="flex items-start gap-3">
                            <i data-lucide="check-circle-2" class="w-4 h-4 text-green-500 mt-0.5 flex-shrink-0"></i>
                            <p class="text-xs text-slate-600 font-medium">24/7 availability for instant support</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <i data-lucide="check-circle-2" class="w-4 h-4 text-green-500 mt-0.5 flex-shrink-0"></i>
                            <p class="text-xs text-slate-600 font-medium">Confidential and judgment-free</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <i data-lucide="check-circle-2" class="w-4 h-4 text-green-500 mt-0.5 flex-shrink-0"></i>
                            <p class="text-xs text-slate-600 font-medium">Evidence-based coping strategies</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <i data-lucide="check-circle-2" class="w-4 h-4 text-green-500 mt-0.5 flex-shrink-0"></i>
                            <p class="text-xs text-slate-600 font-medium">Helps identify when professional support is needed</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <i data-lucide="check-circle-2" class="w-4 h-4 text-green-500 mt-0.5 flex-shrink-0"></i>
                            <p class="text-xs text-slate-600 font-medium">Chat history saved automatically</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                     <div class="flex items-center gap-2 mb-3 text-orange-600 font-bold text-sm">
                        <i data-lucide="alert-circle" class="w-5 h-5"></i>
                        <span>Important Note</span>
                    </div>
                    <p class="text-xs text-slate-500 leading-relaxed mb-5">
                        The AI Coach provides general support and guidance, but is not a replacement for professional mental health care.
                        <br><br>
                        For serious concerns or crisis situations, please contact a counselor or emergency services immediately.
                    </p>
                    <a href="/counselling" class="block w-full py-3 bg-[#a855f7] hover:bg-[#9333ea] text-white text-center rounded-lg text-sm font-bold transition-all shadow-md hover:shadow-lg transform active:scale-95">
                        Book Counselor Session
                    </a>
                </div>

                <div class="bg-purple-50 border border-purple-100 rounded-xl p-6 text-center shadow-sm">
                    <div class="flex justify-center mb-3">
                        <i data-lucide="heart" class="w-8 h-8 text-purple-600 animate-pulse"></i>
                    </div>
                    <p class="text-slate-800 text-xs font-bold mb-1">Remember: Seeking support is a sign of strength, not weakness.</p>
                    <p class="text-[10px] text-slate-500 font-medium">You're taking an important step in caring for your mental health.</p>
                </div>

            </div> 
            </div>
    </div>

    <script th:inline="javascript">
document.addEventListener("DOMContentLoaded", function () {
    const container = document.getElementById("messages-container");
    if (container) {
        container.scrollTop = container.scrollHeight;
    }

    if (typeof lucide !== "undefined") {
        lucide.createIcons();
    }
});
</script>

<script>
function fillInput(val) {
    const input = document.getElementById('input-message');
    const form = document.getElementById('chat-form');

    if (input && form) {
        input.value = val;
        form.submit();
    }
}
</script>

</th:block>