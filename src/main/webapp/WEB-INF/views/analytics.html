<th:block th:fragment="content(totalStudents, highRiskCount, moderateRiskCount, avgCompletion, avgLoginFrequency,
                             searchQuery, filterRisk, filterDepartment, departments, filteredStudents, selectedStudent, alertMessage, alertType)">
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>if (typeof lucide !== 'undefined') lucide.createIcons();</script>

    <div class="p-8">

        <!-- JavaScript Utility Functions for Styling/Interaction -->
        <script>
            // Utility function to set dynamic colors based on risk level
            function getRiskLevelColor(level) {
                switch (level) {
                    case 'low': return 'bg-green-100 text-green-800';
                    case 'moderate': return 'bg-yellow-100 text-yellow-800';
                    case 'high': return 'bg-red-100 text-red-800';
                    default: return 'bg-slate-100 text-slate-800';
                }
            }
            
            // Utility function to set dynamic colors for progress bar
            function getProgressColor(value) {
                if (value >= 70) return 'bg-green-600';
                if (value >= 40) return 'bg-yellow-600';
                return 'bg-red-600';
            }

            // Function to handle the CSV export (Replicates handleExportReport)
            function handleExportReport(students, avgCompletion, avgLoginFrequency) {
                
                // Collect student data
                const headers = ['Student ID', 'Name', 'Email', 'Department', 'Risk Level', 'Login Frequency', 'Module Completion (%)', 'Forum Posts', 'Assessments Taken', 'AI Coach Usage', 'Last Login', 'Trend'];
                
                const csvData = students.map(student => [
                    student.studentId,
                    student.name,
                    student.email,
                    student.department,
                    student.riskLevel.toUpperCase(),
                    student.loginFrequency,
                    student.moduleCompletion,
                    student.forumPosts,
                    student.assessmentsTaken,
                    student.aiCoachUsage,
                    student.lastLogin,
                    student.trend.toUpperCase()
                ]);

                // Escape and format CSV rows
                const csvContent = [
                    headers.join(','),
                    ...csvData.map(row => row.map(cell => {
                        const cellStr = String(cell);
                        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                            return `"${cellStr.replace(/"/g, '""')}"`;
                        }
                        return cellStr;
                    }).join(','))
                ].join('\n');

                // Add summary statistics
                const summary = [
                    '# Student Engagement Analytics Report',
                    `# Generated: ${new Date().toLocaleString()}`,
                    `# Total Students in View: ${students.length}`,
                    `# High Risk: ${students.filter(s => s.riskLevel === 'high').length}`,
                    `# Moderate Risk: ${students.filter(s => s.riskLevel === 'moderate').length}`,
                    `# Low Risk: ${students.filter(s => s.riskLevel === 'low').length}`,
                    `# Average Module Completion: ${avgCompletion}%`,
                    `# Average Login Frequency: ${avgLoginFrequency}`,
                    '',
                    ''
                ].join('\n');

                const fullCSV = summary + csvContent;

                // Create blob and download
                const blob = new Blob([fullCSV], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `student_engagement_report_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Display success message (using custom method since we cannot use alert())
                // In a proper MVC setup, this success message would ideally come from the server via flash attributes,
                // but we add this for client-side feedback after download.
                document.getElementById('export-success-message').classList.remove('hidden');
                setTimeout(() => document.getElementById('export-success-message').classList.add('hidden'), 5000);
            }
        </script>
        
        <!-- Flash Alert Message (Success or Flag) -->
        <div th:if="${alertMessage}" th:classappend="${alertType == 'success'} ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'"
             class="mb-6 p-4 border rounded-lg flex items-start gap-3 transition-opacity duration-300">
            <script>document.write('<i data-lucide="check-circle" class="w-5 h-5 flex-shrink-0 mt-0.5"></i>');</script>
            <span th:text="${alertMessage}"></span>
        </div>
        
        <!-- Client-side export success indicator (for handleExportReport JS) -->
        <div id="export-success-message" class="hidden fixed top-4 right-4 z-50 p-4 bg-green-500 text-white rounded-lg shadow-lg">
            üìä Export Successful! File downloaded.
        </div>
        

        <!-- --- DETAIL VIEW (if selectedStudent is present) --- -->
        <div th:if="${selectedStudent != null}">
            <a th:href="@{/analytics(
                searchQuery=${searchQuery}, 
                filterRisk=${filterRisk}, 
                filterDepartment=${filterDepartment})}"
               class="mb-6 px-4 py-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors inline-flex items-center">
                ‚Üê Back to Analytics
            </a>

            <div class="mb-6">
                <div class="flex items-start justify-between">
                    <div class="flex items-start gap-4">
                        <!-- Avatar/Initials -->
                        <div th:with="riskColor=${selectedStudent.isHighRisk()} ? 'bg-red-600' : ${selectedStudent.isModerateRisk()} ? 'bg-yellow-600' : 'bg-green-600'" 
                             th:classappend="${riskColor}"
                             class="w-16 h-16 rounded-full flex items-center justify-center flex-shrink-0 text-white text-xl">
                            <span th:text="${selectedStudent.initials}"></span>
                        </div>
                        
                        <div>
                            <h1 class="text-3xl font-bold text-slate-900 mb-2" th:text="${selectedStudent.name}"></h1>
                            <p class="text-slate-600" th:text="${selectedStudent.email}"></p>
                            <div class="flex items-center gap-4 mt-2">
                                <span class="text-sm text-slate-600" th:text="'ID: ' + ${selectedStudent.studentId}"></span>
                                <span>‚Ä¢</span>
                                <span class="text-sm text-slate-600" th:text="${selectedStudent.department}"></span>
                                <span>‚Ä¢</span>
                                <span th:with="riskBadgeColor=${selectedStudent.isHighRisk()} ? 'bg-red-100 text-red-800' : ${selectedStudent.isModerateRisk()} ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'"
                                      th:classappend="${riskBadgeColor}"
                                      class="inline-flex items-center rounded-full px-3 py-0.5 text-xs font-medium uppercase"
                                      th:text="${selectedStudent.riskLevel} + ' RISK'">
                                </span>
                            </div>
                        </div>
                    </div>
                    <!-- Flag Button -->
                    <a th:href="@{/analytics/flag(id=${selectedStudent.id})}"
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2">
                        <script>document.write('<i data-lucide="alert-triangle" class="w-4 h-4"></i>');</script>
                        Flag for Follow-up
                    </a>
                </div>
            </div>

            <!-- Detailed Engagement Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-white rounded-xl shadow-md border border-slate-200 p-6">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-slate-600">Login Frequency</p>
                        <script>document.write('<i data-lucide="activity" class="w-5 h-5 text-blue-600"></i>');</script>
                    </div>
                    <p class="text-3xl font-bold text-slate-900 mb-1" th:text="${selectedStudent.loginFrequency}"></p>
                    <p class="text-sm text-slate-600">logins this month</p>
                    <div class="mt-3 flex items-center gap-2">
                        <div th:if="${selectedStudent.isTrendUp()}"><script>document.write('<i data-lucide="trending-up" class="w-4 h-4 text-green-600"></i>');</script></div>
                        <div th:if="${selectedStudent.isTrendDown()}"><script>document.write('<i data-lucide="trending-down" class="w-4 h-4 text-red-600"></i>');</script></div>
                        <span th:classappend="${selectedStudent.isTrendUp()} ? 'text-green-600' : ${selectedStudent.isTrendDown()} ? 'text-red-600' : 'text-slate-600'"
                              class="text-sm">
                            <span th:text="${selectedStudent.trend == 'up' ? 'Increasing' : (selectedStudent.trend == 'down' ? 'Decreasing' : 'Stable')}"></span>
                        </span>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md border border-slate-200 p-6">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-slate-600">Module Completion</p>
                        <script>document.write('<i data-lucide="book-open" class="w-5 h-5 text-purple-600"></i>');</script>
                    </div>
                    <p class="text-3xl font-bold text-slate-900 mb-1" th:text="${selectedStudent.moduleCompletion} + '%'"></p>
                    <div class="w-full bg-slate-200 rounded-full h-2 mt-2">
                        <div th:with="progressColor=${selectedStudent.moduleCompletion >= 70} ? 'bg-green-600' : (${selectedStudent.moduleCompletion >= 40} ? 'bg-yellow-600' : 'bg-red-600')"
                             th:classappend="${progressColor}"
                             class="h-2 rounded-full"
                             th:style="'width: ' + ${selectedStudent.moduleCompletion} + '%'"
                        ></div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md border border-slate-200 p-6">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-slate-600">Last Login</p>
                        <script>document.write('<i data-lucide="clock" class="w-5 h-5 text-orange-600"></i>');</script>
                    </div>
                    <p class="text-2xl font-bold text-slate-900 mb-1" th:text="${selectedStudent.lastLogin}"></p>
                </div>
            </div>

            <!-- Activity Breakdown -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-md border border-slate-200">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-slate-900 mb-4 border-b pb-3">System Usage Details</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <script>document.write('<i data-lucide="message-square" class="w-5 h-5 text-blue-600"></i>');</script>
                                    <span class="text-slate-900">Forum Posts</span>
                                </div>
                                <span class="font-semibold text-slate-900" th:text="${selectedStudent.forumPosts}"></span>
                            </div>

                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <script>document.write('<i data-lucide="book-open" class="w-5 h-5 text-purple-600"></i>');</script>
                                    <span class="text-slate-900">Assessments Taken</span>
                                </div>
                                <span class="font-semibold text-slate-900" th:text="${selectedStudent.assessmentsTaken}"></span>
                            </div>

                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <script>document.write('<i data-lucide="activity" class="w-5 h-5 text-green-600"></i>');</script>
                                    <span class="text-slate-900">AI Coach Sessions</span>
                                </div>
                                <span class="font-semibold text-slate-900" th:text="${selectedStudent.aiCoachUsage}"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md border border-slate-200">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-slate-900 mb-4 border-b pb-3">Engagement Analysis</h3>
                        <div class="space-y-4">
                            <!-- High Risk Alert -->
                            <div th:if="${selectedStudent.isHighRisk()}" class="p-4 bg-red-50 border border-red-200 rounded-lg">
                                <p class="font-medium text-red-900 mb-2 flex items-center gap-2">
                                    <script>document.write('<i data-lucide="alert-triangle" class="w-5 h-5"></i>');</script>
                                    High Risk Alert
                                </p>
                                <p class="text-red-800 text-sm">
                                    This student shows very low engagement across all metrics. Immediate intervention recommended.
                                </p>
                            </div>

                            <!-- Moderate Risk Alert -->
                            <div th:if="${selectedStudent.isModerateRisk()}" class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <p class="font-medium text-yellow-900 mb-2">Moderate Risk</p>
                                <p class="text-yellow-800 text-sm">
                                    Engagement levels are below average. Consider reaching out to offer support.
                                </p>
                            </div>

                            <!-- Low Risk Alert -->
                            <div th:if="${selectedStudent.isLowRisk()}" class="p-4 bg-green-50 border border-green-200 rounded-lg">
                                <p class="font-medium text-green-900 mb-2">Good Engagement</p>
                                <p class="text-green-800 text-sm">
                                    Student is actively engaged with the platform and shows positive participation.
                                </p>
                            </div>

                            <!-- Recommendations -->
                            <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <p class="font-medium text-blue-900 mb-2">Recommendations</p>
                                <ul class="text-blue-800 text-sm space-y-1 list-disc list-inside">
                                    <li th:if="${selectedStudent.loginFrequency < 20}">Encourage more regular platform usage</li>
                                    <li th:if="${selectedStudent.moduleCompletion < 50}">Follow up on incomplete learning modules</li>
                                    <li th:if="${selectedStudent.forumPosts < 5}">Invite to participate in peer support forums</li>
                                    <li th:if="${selectedStudent.assessmentsTaken < 3}">Recommend completing self-assessments</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- --- LIST VIEW (if selectedStudent is null) --- -->
        <div th:unless="${selectedStudent != null}">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-slate-900 mb-2">Student Engagement Analytics</h1>
                <p class="text-slate-600">Monitor system engagement and student progress to identify at-risk students</p>
            </div>

            <!-- Overall Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-6">
                <div class="bg-white rounded-xl shadow-md border border-slate-200 p-6">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-slate-600">Total Students</p>
                        <script>document.write('<i data-lucide="users" class="w-5 h-5 text-blue-600"></i>');</script>
                    </div>
                    <p class="text-3xl font-bold text-slate-900" th:text="${totalStudents}"></p>
                </div>

                <div class="bg-white rounded-xl shadow-md border border-slate-200 p-6">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-slate-600">High Risk</p>
                        <script>document.write('<i data-lucide="alert-triangle" class="w-5 h-5 text-red-600"></i>');</script>
                    </div>
                    <p class="text-3xl font-bold text-red-600" th:text="${highRiskCount}"></p>
                </div>

                <div class="bg-white rounded-xl shadow-md border border-slate-200 p-6">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-slate-600">Moderate Risk</p>
                        <script>document.write('<i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-600"></i>');</script>
                    </div>
                    <p class="text-3xl font-bold text-yellow-600" th:text="${moderateRiskCount}"></p>
                </div>

                <div class="bg-white rounded-xl shadow-md border border-slate-200 p-6">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-slate-600">Avg Completion</p>
                        <script>document.write('<i data-lucide="book-open" class="w-5 h-5 text-purple-600"></i>');</script>
                    </div>
                    <p class="text-3xl font-bold text-slate-900" th:text="${avgCompletion} + '%'"></p>
                </div>

                <div class="bg-white rounded-xl shadow-md border border-slate-200 p-6">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-slate-600">Avg Logins/mo</p>
                        <script>document.write('<i data-lucide="activity" class="w-5 h-5 text-green-600"></i>');</script>
                    </div>
                    <p class="text-3xl font-bold text-slate-900" th:text="${avgLoginFrequency}"></p>
                </div>
            </div>

            <!-- Filters and Actions Form -->
            <form th:action="@{/analytics}" method="get">
                <div class="bg-white rounded-xl shadow-md border border-slate-200">
                    <div class="p-6">
                        <div class="flex flex-col lg:flex-row gap-4">
                            <div class="flex-1 relative">
                                <script>document.write('<i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400"></i>');</script>
                                <input
                                    type="text"
                                    name="searchQuery"
                                    placeholder="Search by name, student ID, or email..."
                                    th:value="${searchQuery}"
                                    class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                            </div>
                            
                            <!-- Risk Filter -->
                            <div class="flex items-center gap-2">
                                <script>document.write('<i data-lucide="filter" class="w-5 h-5 text-slate-600"></i>');</script>
                                <select
                                    name="filterRisk"
                                    onchange="this.form.submit()"
                                    class="px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    <option th:selected="${filterRisk == 'all'}" value="all">All Risk Levels</option>
                                    <option th:selected="${filterRisk == 'low'}" value="low">Low Risk</option>
                                    <option th:selected="${filterRisk == 'moderate'}" value="moderate">Moderate Risk</option>
                                    <option th:selected="${filterRisk == 'high'}" value="high">High Risk</option>
                                </select>
                            </div>
                            
                            <!-- Department Filter -->
                            <div class="flex items-center gap-2">
                                <select
                                    name="filterDepartment"
                                    onchange="this.form.submit()"
                                    class="px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    <option th:each="dept : ${departments}" 
                                            th:selected="${filterDepartment == dept}" 
                                            th:value="${dept}" 
                                            th:text="${dept == 'all' ? 'All Departments' : dept}">
                                    </option>
                                </select>
                            </div>
                            
                            <!-- Search/Filter Submit Button (Hidden, submission is handled by selects) -->
                            <button type="submit" class="hidden">Apply Filters</button>

                            <!-- Export Button (Calls client-side JS function) -->
                            <button type="button" 
                                    th:onclick="'handleExportReport(' + ${#json.toJson(filteredStudents)} + ', ' + ${analyticsService.getAvgCompletion(filteredStudents)} + ', ' + ${analyticsService.getAvgLoginFrequency(filteredStudents)} + ')'"
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2">
                                <script>document.write('<i data-lucide="download" class="w-4 h-4"></i>');</script>
                                Export Report
                            </button>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Student List -->
            <div class="bg-white rounded-xl shadow-md border border-slate-200 mt-6">
                <div class="p-6">
                    <h2 class="text-xl font-bold text-slate-900 flex items-center gap-2 mb-4 border-b pb-4">
                        <script>document.write('<i data-lucide="bar-chart-3" class="w-5 h-5 text-blue-600"></i>');</script>
                        Student Engagement Overview (<span th:text="${filteredStudents.size()}"></span>)
                    </h2>
                    
                    <div th:if="${filteredStudents.size() > 0}" class="space-y-3">
                        <a th:each="student : ${filteredStudents}"
                           th:href="@{/analytics(
                               searchQuery=${searchQuery}, 
                               filterRisk=${filterRisk}, 
                               filterDepartment=${filterDepartment},
                               selectedStudentId=${student.id})}"
                           class="block p-4 border border-slate-200 rounded-lg hover:shadow-md transition-shadow cursor-pointer">
                            
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-4 flex-1">
                                    <!-- Avatar/Initials -->
                                    <div th:with="riskColor=${student.isHighRisk()} ? 'bg-red-600' : ${student.isModerateRisk()} ? 'bg-yellow-600' : 'bg-green-600'"
                                         th:classappend="${riskColor}"
                                         class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0 text-white">
                                        <span th:text="${student.initials}"></span>
                                    </div>
                                    
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <h3 class="font-semibold text-slate-900" th:text="${student.name}"></h3>
                                            <span th:classappend="|${student.isHighRisk() ? 'bg-red-100 text-red-800' : (student.isModerateRisk() ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800')}|"
                                                  class="inline-flex items-center rounded-full px-3 py-0.5 text-xs font-medium uppercase"
                                                  th:text="${student.riskLevel}">
                                            </span>
                                            <span th:if="${student.isTrendDown()}" class="inline-flex items-center rounded-full bg-red-100 px-1.5 py-0.5 text-red-800">
                                                <script>document.write('<i data-lucide="trending-down" class="w-3 h-3"></i>');</script>
                                            </span>
                                        </div>
                                        <div class="flex items-center gap-4 text-sm text-slate-600">
                                            <span th:text="${student.studentId}"></span>
                                            <span>‚Ä¢</span>
                                            <span th:text="${student.department}"></span>
                                            <span>‚Ä¢</span>
                                            <span th:text="'Last login: ' + ${student.lastLogin}"></span>
                                        </div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-4 gap-6 ml-6 flex-shrink-0 w-1/3">
                                    <div class="text-center">
                                        <p class="text-xs text-slate-600 mb-1">Logins</p>
                                        <p class="font-semibold text-slate-900" th:text="${student.loginFrequency}"></p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-xs text-slate-600 mb-1">Completion</p>
                                        <p th:classappend="${student.moduleCompletion >= 70} ? 'text-green-600' : ( ${student.moduleCompletion >= 40} ? 'text-yellow-600' : 'text-red-600')"
                                           class="font-semibold"
                                           th:text="${student.moduleCompletion} + '%'"></p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-xs text-slate-600 mb-1">Posts</p>
                                        <p class="font-semibold text-slate-900" th:text="${student.forumPosts}"></p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-xs text-slate-600 mb-1">Assessments</p>
                                        <p class="font-semibold text-slate-900" th:text="${student.assessmentsTaken}"></p>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                    
                    <div th:unless="${filteredStudents.size() > 0}" class="text-center py-12">
                        <script>document.write('<i data-lucide="bar-chart-3" class="w-16 h-16 text-slate-300 mx-auto mb-4"></i>');</script>
                        <p class="text-slate-600">No data available for the selected filters</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Re-initialize Lucide Icons after Thymeleaf rendering
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    </script>
</th:block>