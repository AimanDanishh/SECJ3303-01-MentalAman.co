<th:block th:fragment="content(sessions, availableTimeSlots, counsellorList, userRole, selectedSession, showDetailsModal, showCancelModal, showRescheduleModal, showReportModal, showUploadModal, showBookingModal, alert, alertType)">
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>if (typeof lucide !== 'undefined') lucide.createIcons();</script>

    <div class="p-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-slate-900 mb-2">Counselling Sessions</h1>
            <p class="text-slate-600">Manage your scheduled counselling sessions</p>
        </div>

        <!-- Flash Alert Message -->
        <div th:if="${alert}" th:classappend="${alertType == 'success'} ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'"
             class="mb-6 p-4 border rounded-lg flex items-start gap-3 transition-opacity duration-300">
            <span th:text="${alert}"></span>
        </div>

        <!-- Utility function for badge rendering (Replicates getStatusBadge) -->
        <script>
            function getStatusBadgeHtml(status) {
                let badgeClass;
                let text;
                let icon;
                switch (status) {
                    case 'scheduled': badgeClass = 'bg-blue-100 text-blue-800'; text = 'Scheduled'; icon = ''; break;
                    case 'confirmed': badgeClass = 'bg-green-100 text-green-800'; text = 'Confirmed'; icon = 'check-circle'; break;
                    case 'completed': badgeClass = 'bg-slate-100 text-slate-800'; text = 'Completed'; icon = ''; break;
                    case 'cancelled': badgeClass = 'bg-red-100 text-red-800'; text = 'Cancelled'; icon = 'x-circle'; break;
                    case 'pending-reschedule': badgeClass = 'bg-yellow-100 text-yellow-800'; text = 'Pending Reschedule'; icon = ''; break;
                    default: badgeClass = 'bg-slate-100 text-slate-800'; text = 'Unknown'; icon = '';
                }
                const iconHtml = icon ? `<i data-lucide="${icon}" class="w-3 h-3 mr-1"></i>` : '';
                return `<span class="inline-flex items-center rounded-full px-3 py-0.5 text-xs font-medium uppercase ${badgeClass}">${iconHtml}${text}</span>`;
            }
        </script>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Session List -->
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 lg:col-span-2">
                <div class="p-6">
                    <h2 class="text-xl font-bold text-slate-900 flex items-center gap-2 mb-4 border-b pb-4">
                        <script>document.write('<i data-lucide="calendar" class="w-5 h-5 text-blue-600"></i>');</script>
                        Your Sessions
                    </h2>
                    
                    <div th:if="${sessions.size() > 0}" class="space-y-4">
                        <div th:each="session : ${sessions}"
                             th:classappend="${session.getCardClass()}"
                             class="p-4 border-2 rounded-lg"
                        >
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex items-start gap-3">
                                    <div th:class="${session.getAvatarClass()}" class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0 text-xl font-semibold">
                                        <span th:text="${session.counsellorId}"></span>
                                    </div>
                                    <div>
                                        <p class="text-slate-900" th:text="${session.counsellor}"></p>
                                        <p class="text-slate-600 text-sm" th:text="${session.specialty}"></p>
                                    </div>
                                </div>
                                <span th:utext="${#strings.escapeXml(getStatusBadgeHtml(session.status))}"></span>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4 mb-3">
                                <div class="flex items-center gap-2 text-slate-700">
                                    <script>document.write('<i data-lucide="calendar" class="w-4 h-4"></i>');</script>
                                    <span class="text-sm" th:text="${session.date}"></span>
                                </div>
                                <div class="flex items-center gap-2 text-slate-700">
                                    <script>document.write('<i data-lucide="clock" class="w-4 h-4"></i>');</script>
                                    <span class="text-sm" th:text="${session.time}"></span>
                                </div>
                                <div class="flex items-center gap-2 text-slate-700">
                                    <script>document.write('<i data-lucide="video" class="w-4 h-4"></i>');</script>
                                    <span class="text-sm" th:text="${session.type}"></span>
                                </div>
                            </div>
                            
                            <p th:if="${session.notes}" class="text-slate-600 text-sm mb-3 p-2 bg-white rounded">
                                üìù <span th:text="${session.notes}"></span>
                            </p>

                            <p th:if="${session.cancellationReason}" class="text-red-700 text-sm mb-3 p-2 bg-red-100 rounded">
                                ‚ùå Cancelled: <span th:text="${session.cancellationReason}"></span>
                            </p>

                            <!-- Action Buttons -->
                            <div class="flex gap-2">
                                <a th:href="@{/counselling(detailId=${session.id}, modal='details')}"
                                    class="flex-1 py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm text-center"
                                >
                                    View Details
                                </a>
                                
                                <a th:if="${session.reportAvailable}"
                                    th:href="@{/counselling(detailId=${session.id}, modal='report')}"
                                    class="py-2 px-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm flex items-center gap-2"
                                >
                                    <script>document.write('<i data-lucide="file-text" class="w-4 h-4"></i>');</script>
                                    Report
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <div th:unless="${sessions.size() > 0}" class="text-center py-12">
                        <script>document.write('<i data-lucide="calendar" class="w-16 h-16 text-slate-300 mx-auto mb-4"></i>');</script>
                        <p class="text-slate-600 mb-4">No sessions scheduled</p>
                        <a th:href="@{/counselling(modal='book')}" class="py-2 px-6 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            Book Your First Session
                        </a>
                    </div>
                </div>
            </div>

            <!-- Sidebar Info -->
            <div class="space-y-6">
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                    <h3 class="text-lg font-bold text-slate-900 mb-4 border-b pb-3">Session Information</h3>
                    <div class="space-y-4">
                        <div class="p-3 bg-blue-50 rounded-lg">
                            <p class="text-blue-900 mb-1">Session Duration</p>
                            <p class="text-blue-700 text-sm">60 minutes per session</p>
                        </div>
                        <div class="p-3 bg-green-50 rounded-lg">
                            <p class="text-green-900 mb-1">Confidential</p>
                            <p class="text-green-700 text-sm">All sessions are private and secure</p>
                        </div>
                        <div class="p-3 bg-purple-50 rounded-lg">
                            <p class="text-purple-900 mb-1">Cancel Policy</p>
                            <p class="text-purple-700 text-sm">Free cancellation 24h before</p>
                        </div>
                        <div class="p-3 bg-yellow-50 rounded-lg">
                            <p class="text-yellow-900 mb-1 flex items-center gap-1">
                                <script>document.write('<i data-lucide="bell" class="w-4 h-4"></i>');</script>
                                Notifications
                            </p>
                            <p class="text-yellow-700 text-sm">Reminders sent 1 hour before</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                    <h3 class="text-lg font-bold text-slate-900 mb-4 border-b pb-3">Quick Actions</h3>
                    <div class="space-y-2">
                        <a th:href="@{/counselling(modal='book')}"
                            class="w-full py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-center block"
                        >
                            Book New Session
                        </a>
                        <button class="w-full py-2 px-4 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors">
                            View All Reports
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- --- MODALS --- -->

        <!-- NF4: Session Details Modal -->
        <div th:if="${showDetailsModal and selectedSession != null}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-slate-900">Session Details</h2>
                    <a th:href="@{/counselling}" class="text-slate-400 hover:text-slate-600 transition-colors">
                        <script>document.write('<i data-lucide="x" class="w-6 h-6"></i>');</script>
                    </a>
                </div>

                <div class="space-y-4 mb-6">
                    <div class="flex items-center gap-4">
                        <div th:class="${selectedSession.getAvatarClass()}" class="w-16 h-16 rounded-full flex items-center justify-center flex-shrink-0 text-white text-xl font-semibold">
                            <span th:text="${selectedSession.counsellorId}"></span>
                        </div>
                        <div>
                            <p class="text-xl font-semibold text-slate-900" th:text="${selectedSession.counsellor}"></p>
                            <p class="text-slate-600" th:text="${selectedSession.specialty}"></p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-slate-50 rounded-lg">
                            <p class="text-sm text-slate-600 mb-1">Date</p>
                            <p class="font-semibold text-slate-900" th:text="${selectedSession.date}"></p>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-lg">
                            <p class="text-sm text-slate-600 mb-1">Time</p>
                            <p class="font-semibold text-slate-900" th:text="${selectedSession.time}"></p>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 rounded-lg">
                        <p class="text-sm text-slate-600 mb-1">Session Type</p>
                        <p class="font-semibold text-slate-900" th:text="${selectedSession.type}"></p>
                    </div>

                    <div class="p-4 bg-slate-50 rounded-lg">
                        <p class="text-sm text-slate-600 mb-1">Status</p>
                        <span th:utext="${#strings.escapeXml(getStatusBadgeHtml(selectedSession.status))}"></span>
                    </div>

                    <div th:if="${selectedSession.notes}" class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-sm text-blue-800 mb-1">Notes</p>
                        <p class="text-blue-900" th:text="${selectedSession.notes}"></p>
                    </div>
                </div>

                <!-- Action Buttons based on status and role -->
                <div class="flex flex-col gap-3">
                    <!-- AF2: Student confirms attendance -->
                    <form th:if="${userRole == 'student' and selectedSession.status == 'scheduled' and !selectedSession.studentConfirmed}" 
                          th:action="@{/counselling/confirm/{id}(id=${selectedSession.id})}" method="post">
                        <button type="submit" class="w-full py-3 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2">
                            <script>document.write('<i data-lucide="check-circle" class="w-5 h-5"></i>');</script>
                            Confirm Attendance
                        </button>
                    </form>

                    <div th:if="${selectedSession.status != 'completed' and selectedSession.status != 'cancelled'}" class="flex gap-3">
                        <!-- AF2: Request reschedule -->
                        <a th:href="@{/counselling(detailId=${selectedSession.id}, modal='reschedule')}"
                            class="flex-1 py-3 px-4 border border-blue-300 text-blue-700 rounded-lg hover:bg-blue-50 transition-colors text-center"
                        >
                            Request Reschedule
                        </a>
                        <!-- AF1: Cancel session -->
                        <a th:href="@{/counselling(detailId=${selectedSession.id}, modal='cancel')}"
                            class="flex-1 py-3 px-4 border border-red-300 text-red-700 rounded-lg hover:bg-red-50 transition-colors text-center"
                        >
                            Cancel Session
                        </a>
                    </div>
                    
                    <!-- NF7: Counsellor upload button -->
                    <a th:if="${userRole == 'counsellor' and selectedSession.status == 'completed' and !selectedSession.reportAvailable}"
                        th:href="@{/counselling(detailId=${selectedSession.id}, modal='upload')}"
                        class="w-full py-3 px-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center gap-2"
                    >
                        <script>document.write('<i data-lucide="file-text" class="w-5 h-5"></i>');</script>
                        Upload Session Report
                    </a>

                    <a th:href="@{/counselling}" class="w-full py-3 px-4 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors text-center">
                        Close
                    </a>
                </div>
            </div>
        </div>

        <!-- AF1: Cancel Session Modal -->
        <div th:if="${showCancelModal and selectedSession != null}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                        <script>document.write('<i data-lucide="alert-circle" class="w-5 h-5 text-red-600"></i>');</script>
                        Cancel Session
                    </h2>
                    <a th:href="@{/counselling(detailId=${selectedSession.id}, modal='details')}" class="text-slate-400 hover:text-slate-600 transition-colors">
                        <script>document.write('<i data-lucide="x" class="w-5 h-5"></i>');</script>
                    </a>
                </div>

                <p class="text-slate-600 mb-4">
                    Are you sure you want to cancel your session with <span th:text="${selectedSession.counsellor}"></span>?
                </p>

                <form th:action="@{/counselling/cancel/{id}(id=${selectedSession.id})}" method="post">
                    <div class="mb-6">
                        <label for="cancellationReason" class="block text-sm font-medium text-slate-700 mb-2">
                            Cancellation Reason *
                        </label>
                        <textarea id="cancellationReason" name="cancellationReason" required
                            placeholder="Please provide a reason for cancellation..."
                            class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                            rows="4"></textarea>
                    </div>

                    <div class="flex gap-3">
                        <a th:href="@{/counselling(detailId=${selectedSession.id}, modal='details')}"
                            class="flex-1 py-2 px-4 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors text-center"
                        >
                            Keep Session
                        </a>
                        <button type="submit"
                            class="flex-1 py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                        >
                            Cancel Session
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- AF2: Reschedule Modal -->
        <div th:if="${showRescheduleModal and selectedSession != null}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-slate-900">Request Reschedule</h2>
                    <a th:href="@{/counselling(detailId=${selectedSession.id}, modal='details')}" class="text-slate-400 hover:text-slate-600 transition-colors">
                        <script>document.write('<i data-lucide="x" class="w-6 h-6"></i>');</script>
                    </a>
                </div>

                <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                    <p class="text-blue-900 mb-1">Current Session</p>
                    <p class="text-blue-700" th:text="${selectedSession.date} + ' at ' + ${selectedSession.time}"></p>
                </div>

                <form th:action="@{/counselling/reschedule/{id}(id=${selectedSession.id})}" method="post">
                    <h3 class="font-semibold text-slate-900 mb-4">Select New Time Slot</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
                        <div th:each="slot : ${availableTimeSlots}" class="flex flex-col">
                            <input type="radio" th:id="'slot-'+${slot.date}+${slot.time}" name="newDate" th:value="${slot.date}" required class="hidden" 
                                onclick="document.querySelector('input[name=\'newTime\']').value=this.getAttribute('data-time')" th:attr="data-time=${slot.time}"/>
                            <input type="hidden" name="newTime" value="" />
                            <label th:for="'slot-'+${slot.date}+${slot.time}" 
                                class="p-4 border-2 rounded-lg text-left transition-all border-slate-200 hover:border-slate-300 hover:bg-slate-50 cursor-pointer has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                                <p class="font-medium text-slate-900" th:text="${slot.date}"></p>
                                <p class="text-slate-600 text-sm" th:text="${slot.time}"></p>
                            </label>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <a th:href="@{/counselling(detailId=${selectedSession.id}, modal='details')}"
                            class="flex-1 py-3 px-4 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors text-center"
                        >
                            Cancel
                        </a>
                        <button type="submit"
                            class="flex-1 py-3 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed transition-colors"
                        >
                            Request Reschedule
                        </button>
                    </div>
                </form>
                <p class="text-xs text-slate-500 mt-4 text-center">
                    The counsellor will be notified and must confirm the new schedule
                </p>
            </div>
        </div>

        <!-- NF7: Upload Report Modal (Counsellor) -->
        <div th:if="${showUploadModal and selectedSession != null}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-slate-900">Upload Session Report</h2>
                    <a th:href="@{/counselling(detailId=${selectedSession.id}, modal='details')}" class="text-slate-400 hover:text-slate-600 transition-colors">
                        <script>document.write('<i data-lucide="x" class="w-6 h-6"></i>');</script>
                    </a>
                </div>

                <form th:action="@{/counselling/report/upload/{id}(id=${selectedSession.id})}" method="post">
                    <!-- Note: We omit the reportTitle field for simplicity in MVC but ensure the content field is mandatory -->

                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">
                                Session Notes & Observations *
                            </label>
                            <textarea name="reportContent" required
                                placeholder="Document the session summary, observations, progress, recommendations, and next steps..."
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                rows="8"></textarea>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <a th:href="@{/counselling(detailId=${selectedSession.id}, modal='details')}"
                            class="flex-1 py-3 px-4 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors text-center"
                        >
                            Cancel
                        </a>
                        <button type="submit"
                            class="flex-1 py-3 px-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                        >
                            Upload Report
                        </button>
                    </div>
                </form>
                <p class="text-xs text-slate-500 mt-4 text-center">
                    The student will be notified when the report is uploaded
                </p>
            </div>
        </div>

        <!-- NF9: View Report Modal (Student) -->
        <div th:if="${showReportModal and selectedSession != null}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-slate-900">Session Report</h2>
                    <a th:href="@{/counselling}" class="text-slate-400 hover:text-slate-600 transition-colors">
                        <script>document.write('<i data-lucide="x" class="w-6 h-6"></i>');</script>
                    </a>
                </div>

                <div class="space-y-4">
                    <div class="p-4 bg-slate-50 rounded-lg">
                        <p class="text-sm text-slate-600 mb-1">Counsellor</p>
                        <p class="font-semibold text-slate-900" th:text="${selectedSession.counsellor}"></p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-slate-50 rounded-lg">
                            <p class="text-sm text-slate-600 mb-1">Session Date</p>
                            <p class="font-semibold text-slate-900" th:text="${selectedSession.date}"></p>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-lg">
                            <p class="text-sm text-slate-600 mb-1">Time</p>
                            <p class="font-semibold text-slate-900" th:text="${selectedSession.time}"></p>
                        </div>
                    </div>

                    <div class="p-4 bg-purple-50 border border-purple-200 rounded-lg">
                        <p class="font-medium text-purple-900 mb-3">Session Summary</p>
                        <p class="text-purple-800 text-sm whitespace-pre-line" th:text="${selectedSession.reportContent}"></p>
                    </div>

                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-sm text-blue-800">
                            üìã This report is confidential and stored securely. You can review it anytime for reflection and follow-up.
                        </p>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <a th:href="@{/counselling}" class="flex-1 py-3 px-4 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors text-center">
                        Close
                    </a>
                    <a th:href="@{/counselling(modal='book')}" class="flex-1 py-3 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-center">
                        Book Follow-up Session
                    </a>
                </div>
            </div>
        </div>

        <!-- NF10: Book New Session Modal -->
        <div th:if="${showBookingModal}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-slate-900">Book New Session</h2>
                    <a th:href="@{/counselling}" class="text-slate-400 hover:text-slate-600 transition-colors">
                        <script>document.write('<i data-lucide="x" class="w-6 h-6"></i>');</script>
                    </a>
                </div>
                
                <form th:action="@{/counselling/book}" method="post">
                    <div class="space-y-4 mb-6">
                        <!-- Counsellor Selection -->
                        <div>
                            <label for="selectedCounsellor" class="block text-sm font-medium text-slate-700 mb-2">
                                Select Counsellor *
                            </label>
                            <select id="selectedCounsellor" name="selectedCounsellor" required
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">-- Select a counsellor --</option>
                                <option th:each="counsellor : ${counsellorList}" 
                                        th:value="${counsellor.name}" 
                                        th:text="${counsellor.name} + ' - ' + ${counsellor.specialty}">
                                </option>
                            </select>
                        </div>

                        <!-- Session Type Selection -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-3">Session Type *</label>
                            <div class="grid grid-cols-2 gap-3">
                                <label for="online-type" class="p-4 border-2 rounded-lg transition-all border-slate-200 hover:border-slate-300 hover:bg-slate-50 cursor-pointer has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 text-center">
                                    <input type="radio" id="online-type" name="sessionType" value="online" checked required class="hidden" onclick="document.getElementById('location-group').classList.add('hidden')"/>
                                    <script>document.write('<i data-lucide="monitor" class="w-6 h-6 mx-auto mb-2 text-blue-600"></i>');</script>
                                    <p class="font-medium text-blue-900">Online</p>
                                    <p class="text-xs text-slate-600 mt-1">Video Call</p>
                                </label>
                                <label for="physical-type" class="p-4 border-2 rounded-lg transition-all border-slate-200 hover:border-slate-300 hover:bg-slate-50 cursor-pointer has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 text-center">
                                    <input type="radio" id="physical-type" name="sessionType" value="physical" required class="hidden" onclick="document.getElementById('location-group').classList.remove('hidden')"/>
                                    <script>document.write('<i data-lucide="map-pin" class="w-6 h-6 mx-auto mb-2 text-slate-400"></i>');</script>
                                    <p class="font-medium text-slate-700">Physical</p>
                                    <p class="text-xs text-slate-600 mt-1">In-Person</p>
                                </label>
                            </div>
                        </div>

                        <!-- Location Selection (if Physical) - Controlled by JS onclick above -->
                        <div id="location-group" class="hidden">
                            <label for="sessionLocation" class="block text-sm font-medium text-slate-700 mb-2">Session Location *</label>
                            <select id="sessionLocation" name="sessionLocation" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">-- Select location --</option>
                                <option value="Counselling Center - Room 101">Counselling Center - Room 101</option>
                                <option value="Counselling Center - Room 102">Counselling Center - Room 102</option>
                                <option value="Student Wellness Center - Office A">Student Wellness Center - Office A</option>
                            </select>
                            <p class="text-xs text-slate-500 mt-2 flex items-center gap-1">
                                <script>document.write('<i data-lucide="map-pin" class="w-3 h-3"></i>');</script>
                                The selected location will be confirmed by the counsellor
                            </p>
                        </div>

                        <!-- Time Slot Selection -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-3">Select Time Slot *</label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <label th:each="slot : ${availableTimeSlots}" 
                                    th:for="${slot.date} + ${slot.time}" 
                                    class="p-4 border-2 rounded-lg text-left transition-all border-slate-200 hover:border-slate-300 hover:bg-slate-50 cursor-pointer has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                                    <input type="radio" th:id="${slot.date} + ${slot.time}" name="selectedTimeSlot" th:value="${slot.date} + '|' + ${slot.time}" required class="hidden"
                                        onclick="document.querySelector('input[name=\'selectedDate\']').value=this.getAttribute('data-date'); document.querySelector('input[name=\'selectedTime\']').value=this.getAttribute('data-time')"
                                        th:attr="data-date=${slot.date}, data-time=${slot.time}"
                                    />
                                    <p class="font-medium text-slate-900" th:text="${slot.date}"></p>
                                    <p class="text-slate-600 text-sm" th:text="${slot.time}"></p>
                                </label>
                                <!-- Hidden fields to capture Date and Time separately for Controller -->
                                <input type="hidden" name="selectedDate" value="" />
                                <input type="hidden" name="selectedTime" value="" />
                            </div>
                        </div>

                        <!-- Reason for Booking -->
                        <div>
                            <label for="bookingReason" class="block text-sm font-medium text-slate-700 mb-2">Reason for Booking *</label>
                            <textarea id="bookingReason" name="bookingReason" required
                                placeholder="Please provide a reason for booking this session..."
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                rows="4"></textarea>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <a th:href="@{/counselling}" class="flex-1 py-3 px-4 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors text-center">
                            Cancel
                        </a>
                        <button type="submit"
                            class="flex-1 py-3 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed transition-colors"
                        >
                            Book Session
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        // Re-initialize Lucide Icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    </script>
</th:block>