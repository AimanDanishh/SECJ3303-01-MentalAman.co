<th:block th:fragment="content(user, userProfile, isEditing)">
    <!-- Load Lucide Icons if not already loaded in the main layout -->
    <script th:if="${isEditing}" src="https://unpkg.com/lucide@latest"></script>
    <script th:if="${isEditing}">if (typeof lucide !== 'undefined') lucide.createIcons();</script>

    <div class="p-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-slate-900 mb-2">Profile Settings</h1>
            <p class="text-slate-600">Manage your account information and preferences</p>
        </div>

        <!-- Success Message (Replaces React alert) -->
        <div th:if="${successMessage}" class="mb-6 p-4 bg-green-100 border border-green-300 text-green-800 rounded-lg">
            <span th:text="${successMessage}"></span>
        </div>

        <form th:action="@{/profile/save}" th:object="${userProfile}" method="post">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Profile Overview (Left Column) -->
                <div class="lg:col-span-1">
                    <!-- Profile Card -->
                    <div class="bg-white rounded-xl shadow-lg border border-slate-200">
                        <div class="p-6">
                            <div class="text-center mb-6">
                                <div class="w-32 h-32 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center mx-auto mb-4">
                                    <script>document.write('<i data-lucide="user" class="w-16 h-16 text-white"></i>');</script>
                                </div>
                                <h2 class="text-2xl font-bold text-slate-900 mb-1" th:text="*{fullName}"></h2>
                                <span class="inline-flex items-center rounded-full bg-blue-100 px-3 py-0.5 text-sm font-medium text-blue-800 capitalize" th:text="${user.role}"></span>
                                <p class="text-slate-600 text-sm" th:text="${user.email}"></p>
                            </div>

                            <div class="space-y-3 mb-6">
                                <div class="flex items-center gap-3 text-sm">
                                    <script>document.write('<i data-lucide="phone" class="w-4 h-4 text-slate-400"></i>');</script>
                                    <span class="text-slate-600" th:text="*{phone}"></span>
                                </div>
                                <div class="flex items-center gap-3 text-sm">
                                    <script>document.write('<i data-lucide="map-pin" class="w-4 h-4 text-slate-400"></i>');</script>
                                    <span class="text-slate-600" th:text="*{location}"></span>
                                </div>
                                <div class="flex items-center gap-3 text-sm">
                                    <script>document.write('<i data-lucide="calendar" class="w-4 h-4 text-slate-400"></i>');</script>
                                    <span class="text-slate-600">Joined Nov 2024</span>
                                </div>
                            </div>

                            <!-- Edit/Save Button (Replaces the React logic with URL switching) -->
                            <div th:if="${!isEditing}">
                                <a th:href="@{/profile/edit}" 
                                   class="w-full py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                                    <script>document.write('<i data-lucide="edit-2" class="w-4 h-4"></i>');</script>
                                    Edit Profile
                                </a>
                            </div>
                            <div th:if="${isEditing}" class="flex gap-2">
                                <a th:href="@{/profile}"
                                   class="py-2 px-3 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors flex items-center gap-1 flex-1 justify-center">
                                    <script>document.write('<i data-lucide="x" class="w-4 h-4"></i>');</script>
                                    Cancel
                                </a>
                                <button type="submit"
                                   class="py-2 px-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-1 flex-1 justify-center">
                                    <script>document.write('<i data-lucide="save" class="w-4 h-4"></i>');</script>
                                    Save
                                </button>
                            </div>

                        </div>
                    </div>

                    <!-- Stats Card -->
                    <div class="bg-white rounded-xl shadow-lg border border-slate-200 mt-6">
                        <div class="p-6">
                            <h3 class="text-xl font-semibold mb-4 text-slate-900">Activity Stats</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <!-- Thymeleaf loop to replicate React stats.map -->
                                <div class="text-center p-3 bg-slate-50 rounded-lg">
                                    <div class="text-2xl mb-1">üìö</div>
                                    <p class="text-xl font-bold text-slate-900" th:text="*{modulesCompleted}"></p>
                                    <p class="text-xs text-slate-600">Modules Completed</p>
                                </div>
                                <div class="text-center p-3 bg-slate-50 rounded-lg">
                                    <div class="text-2xl mb-1">üí¨</div>
                                    <p class="text-xl font-bold text-slate-900" th:text="*{forumPosts}"></p>
                                    <p class="text-xs text-slate-600">Forum Posts</p>
                                </div>
                                <div class="text-center p-3 bg-slate-50 rounded-lg">
                                    <div class="text-2xl mb-1">üìÖ</div>
                                    <p class="text-xl font-bold text-slate-900" th:text="*{daysActive}"></p>
                                    <p class="text-xs text-slate-600">Days Active</p>
                                </div>
                                <div class="text-center p-3 bg-slate-50 rounded-lg">
                                    <div class="text-2xl mb-1">üèÜ</div>
                                    <p class="text-xl font-bold text-slate-900" th:text="*{pointsEarned}"></p>
                                    <p class="text-xs text-slate-600">Points Earned</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Details & Settings (Right Column) -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Personal Information Card -->
                    <div class="bg-white rounded-xl shadow-lg border border-slate-200">
                        <div class="p-6">
                            <h3 class="text-xl font-semibold text-slate-900 flex items-center gap-2 mb-4 border-b pb-4">
                                <script>document.write('<i data-lucide="user" class="w-5 h-5"></i>');</script>
                                Personal Information
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                
                                <!-- Full Name -->
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Full Name</label>
                                    <div th:if="${isEditing}">
                                        <input type="text" th:field="*{fullName}" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                    <div th:unless="${isEditing}">
                                        <p class="text-slate-900 py-2" th:text="*{fullName}"></p>
                                    </div>
                                </div>

                                <!-- Email Address (Read-only, derived from User Model) -->
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Email Address</label>
                                    <p class="text-slate-900 py-2" th:text="${user.email}"></p>
                                </div>

                                <!-- Phone Number -->
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Phone Number</label>
                                    <div th:if="${isEditing}">
                                        <input type="tel" th:field="*{phone}" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                    <div th:unless="${isEditing}">
                                        <p class="text-slate-900 py-2" th:text="*{phone}"></p>
                                    </div>
                                </div>

                                <!-- Location -->
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Location</label>
                                    <div th:if="${isEditing}">
                                        <input type="text" th:field="*{location}" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                    <div th:unless="${isEditing}">
                                        <p class="text-slate-900 py-2" th:text="*{location}"></p>
                                    </div>
                                </div>

                                <!-- Date of Birth -->
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Date of Birth</label>
                                    <div th:if="${isEditing}">
                                        <!-- Note: Thymeleaf handles LocalDate binding to the date input type -->
                                        <input type="date" th:field="*{dateOfBirth}" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                    <div th:unless="${isEditing}">
                                        <p class="text-slate-900 py-2" th:text="*{#dates.format(userProfile.dateOfBirth, 'MMMM d, yyyy')}"></p>
                                    </div>
                                </div>

                                <!-- Emergency Contact -->
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Emergency Contact</label>
                                    <div th:if="${isEditing}">
                                        <input type="text" th:field="*{emergencyContact}" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                    <div th:unless="${isEditing}">
                                        <p class="text-slate-900 py-2" th:text="*{emergencyContact}"></p>
                                    </div>
                                </div>

                                <!-- Bio -->
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Bio</label>
                                    <div th:if="${isEditing}">
                                        <textarea th:field="*{bio}" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                    </div>
                                    <div th:unless="${isEditing}">
                                        <p class="text-slate-900 py-2" th:text="*{bio}"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notification Preferences Card -->
                    <div class="bg-white rounded-xl shadow-lg border border-slate-200">
                        <div class="p-6">
                            <h3 class="text-xl font-semibold text-slate-900 flex items-center gap-2 mb-4 border-b pb-4">
                                <script>document.write('<i data-lucide="bell" class="w-5 h-5"></i>');</script>
                                Notification Preferences
                            </h3>
                            <div class="space-y-4">
                                <!-- Preference 1: Email Notifications -->
                                <div class="flex items-center justify-between py-3 border-b border-slate-100">
                                    <div>
                                        <p class="font-medium text-slate-900">Email Notifications</p>
                                        <p class="text-sm text-slate-600">Receive email updates about your activity</p>
                                    </div>
                                    <label th:if="${isEditing}" class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" th:field="*{emailNotifications}" class="sr-only peer" />
                                        <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                    <span th:unless="${isEditing}" th:text="*{emailNotifications ? 'Enabled' : 'Disabled'}" 
                                          th:classappend="*{emailNotifications} ? 'text-green-600 font-medium' : 'text-red-600'"></span>
                                </div>
                                
                                <!-- Preference 2: Push Notifications -->
                                <div class="flex items-center justify-between py-3 border-b border-slate-100">
                                    <div>
                                        <p class="font-medium text-slate-900">Push Notifications</p>
                                        <p class="text-sm text-slate-600">Get push notifications on your device</p>
                                    </div>
                                    <label th:if="${isEditing}" class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" th:field="*{pushNotifications}" class="sr-only peer" />
                                        <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                    <span th:unless="${isEditing}" th:text="*{pushNotifications ? 'Enabled' : 'Disabled'}" 
                                          th:classappend="*{pushNotifications} ? 'text-green-600 font-medium' : 'text-red-600'"></span>
                                </div>
                                
                                <!-- Preference 3: Anonymous Mode -->
                                <div class="flex items-center justify-between py-3">
                                    <div>
                                        <p class="font-medium text-slate-900">Anonymous Mode</p>
                                        <p class="text-sm text-slate-600">Hide your name in forum posts</p>
                                    </div>
                                    <label th:if="${isEditing}" class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" th:field="*{anonymousMode}" class="sr-only peer" />
                                        <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                    <span th:unless="${isEditing}" th:text="*{anonymousMode ? 'Enabled' : 'Disabled'}" 
                                          th:classappend="*{anonymousMode} ? 'text-green-600 font-medium' : 'text-red-600'"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Security Settings Card -->
                    <div class="bg-white rounded-xl shadow-lg border border-slate-200">
                        <div class="p-6">
                            <h3 class="text-xl font-semibold text-slate-900 flex items-center gap-2 mb-4 border-b pb-4">
                                <script>document.write('<i data-lucide="lock" class="w-5 h-5"></i>');</script>
                                Security Settings
                            </h3>
                            <div class="space-y-4">
                                <!-- Change Password -->
                                <button type="button" class="w-full py-3 px-4 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors text-left flex items-center justify-between">
                                    <span>Change Password</span>
                                    <span class="text-slate-400">‚Üí</span>
                                </button>
                                <!-- Two-Factor Authentication -->
                                <button type="button" class="w-full py-3 px-4 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors text-left flex items-center justify-between">
                                    <span>Two-Factor Authentication</span>
                                    <span class="inline-flex items-center rounded-full bg-yellow-100 px-3 py-0.5 text-sm font-medium text-yellow-800">Not Enabled</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Privacy & Data Card -->
                    <div class="bg-white rounded-xl shadow-lg border border-slate-200">
                        <div class="p-6">
                            <h3 class="text-xl font-semibold text-slate-900 flex items-center gap-2 mb-4 border-b pb-4">
                                <script>document.write('<i data-lucide="shield" class="w-5 h-5"></i>');</script>
                                Privacy & Data
                            </h3>
                            <div class="space-y-4">
                                <button type="button" class="w-full py-3 px-4 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors text-left">
                                    Download My Data
                                </button>
                                <button type="button" class="w-full py-3 px-4 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors text-left">
                                    Privacy Policy
                                </button>
                                <button type="button" class="w-full py-3 px-4 border border-red-300 text-red-700 rounded-lg hover:bg-red-50 transition-colors text-left">
                                    Delete Account
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    
    <script th:if="${!isEditing}">
        // Re-initialize Lucide Icons for the View Mode if needed, though usually done in app-layout
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    </script>
</th:block>