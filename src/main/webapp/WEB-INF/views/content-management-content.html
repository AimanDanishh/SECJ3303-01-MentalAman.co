<th:block th:fragment="content(selectedType, isCreating, isEditing, isViewing, selectedItem, contentItems, filteredContent, categories, formData, showError, errorMessage, showSuccess, successMessage)">
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>if (typeof lucide !== 'undefined') lucide.createIcons();</script>

    <div class="p-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-slate-900 mb-2">Content Management</h1>
            <p class="text-slate-600">Create, edit, and manage learning modules, forum topics, and resources</p>
        </div>

        <!-- Success Alert (Flash Attribute) -->
        <div th:if="${successMessage}" class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg flex items-start gap-3">
            <script>document.write('<i data-lucide="check-circle" class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"></i>');</script>
            <div class="flex-1">
                <p class="font-medium text-green-900 mb-1">Success</p>
                <p class="text-green-700 text-sm" th:text="${successMessage}"></p>
            </div>
        </div>

        <!-- Error Alert (Flash Attribute) -->
        <div th:if="${errorMessage}" class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg flex items-start gap-3">
            <script>document.write('<i data-lucide="alert-circle" class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5"></i>');</script>
            <div class="flex-1">
                <p class="font-medium text-red-900 mb-1">Error</p>
                <p class="text-red-700 text-sm" th:text="${errorMessage}"></p>
            </div>
        </div>
        
        <!-- Utility function for icon rendering (Replicates getTypeIcon and getColor) -->
        <script>
            function getTypeIconHtml(type) {
                let iconName;
                let colorClass;
                switch (type) {
                    case 'module': iconName = 'book-open'; colorClass = 'text-blue-600'; break;
                    case 'forum': iconName = 'message-square'; colorClass = 'text-purple-600'; break;
                    case 'resource': iconName = 'file-text'; colorClass = 'text-green-600'; break;
                    default: iconName = 'file-text'; colorClass = 'text-slate-600'; break;
                }
                return `<i data-lucide="${iconName}" class="w-5 h-5 ${colorClass}"></i>`;
            }
        </script>


        <!-- --- View Detail Mode --- -->
        <div th:if="${isViewing and selectedItem != null}" class="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
            <div class="flex items-start justify-between border-b pb-4 mb-4">
                <div class="flex items-start gap-3">
                    <span th:utext="${#strings.escapeXml(getTypeIconHtml(selectedItem.type))}"></span>
                    <div>
                        <h2 th:class="${selectedItem.typeColor}" class="text-2xl font-bold mb-1" th:text="${selectedItem.title}"></h2>
                        <div class="flex items-center gap-2 mt-2">
                            <span th:class="${selectedItem.getStatusBadgeClass()}" class="inline-flex items-center rounded-full px-3 py-0.5 text-xs font-medium uppercase" th:text="${selectedItem.status}"></span>
                            <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-0.5 text-xs font-medium text-slate-800" th:text="${selectedItem.category}"></span>
                            <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-0.5 text-xs font-medium text-slate-800" th:text="${selectedItem.type}"></span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <!-- Edit Button -->
                    <a th:href="@{/content(editId=${selectedItem.id}, selectedType=${selectedItem.type})}"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                        <script>document.write('<i data-lucide="edit-2" class="w-4 h-4"></i>');</script>
                        Edit
                    </a>
                    <!-- Back/Cancel Button -->
                    <a th:href="@{/content(selectedType=${selectedItem.type})}"
                        class="px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors">
                        <script>document.write('<i data-lucide="x" class="w-4 h-4"></i>');</script>
                    </a>
                </div>
            </div>

            <div class="space-y-6">
                <!-- Description Section -->
                <div class="pb-6 border-b border-slate-200">
                    <h3 class="font-semibold text-slate-900 mb-3">Description</h3>
                    <p class="text-slate-700 leading-relaxed" th:text="${selectedItem.description}"></p>
                </div>

                <!-- Content Section -->
                <div class="pb-6 border-b border-slate-200">
                    <h3 class="font-semibold text-slate-900 mb-3">Content</h3>
                    <div class="bg-slate-50 rounded-lg p-6">
                        <p class="text-slate-700 mb-4">
                           [Mock content for <span th:text="${selectedItem.type}"></span>: <span th:text="${selectedItem.title}"></span>]
                        </p>
                        <!-- Simplified mock content based on type -->
                        <div th:if="${selectedItem.type == 'module'}">
                            <h4 class="font-semibold text-slate-900 mb-2">Module Structure:</h4>
                            <ul class="list-disc list-inside space-y-2 text-slate-700">
                                <li>Interactive video lessons (15-20 minutes)</li>
                                <li>Downloadable resources and worksheets</li>
                                <li>Knowledge check quizzes</li>
                            </ul>
                        </div>
                        <div th:if="${selectedItem.type == 'forum'}">
                            <h4 class="font-semibold text-slate-900 mb-2">Forum Guidelines:</h4>
                            <p class="text-sm text-slate-700">This is a moderated space for peer support and discussion. Please adhere to community guidelines (respect, confidentiality).</p>
                        </div>
                        <div th:if="${selectedItem.type == 'resource'}">
                             <h4 class="font-semibold text-slate-900 mb-2">Resource Links:</h4>
                             <p class="text-sm text-slate-700">External link to <span th:text="${selectedItem.title}"></span></p>
                        </div>
                    </div>
                </div>

                <!-- Metadata Section -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-semibold text-slate-900 mb-3">Publication Details</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-600">Created by:</span>
                                <span class="text-slate-900 font-medium" th:text="${selectedItem.createdBy}"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Created on:</span>
                                <span class="text-slate-900" th:text="${selectedItem.createdDate}"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Last modified:</span>
                                <span class="text-slate-900" th:text="${selectedItem.lastModified}"></span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="font-semibold text-slate-900 mb-3">Engagement Stats</h3>
                        <!-- Mock stats as they are client-generated in TSX -->
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-600">Total views:</span>
                                <span class="text-slate-900 font-medium">456</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Completion rate:</span>
                                <span class="text-slate-900">78%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Avg. rating:</span>
                                <span class="text-slate-900">⭐⭐⭐⭐ 4.2/5</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attachments Section (Mock Data) -->
                <div>
                    <h3 class="font-semibold text-slate-900 mb-3">Attachments</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="p-3 bg-slate-50 rounded-lg flex items-center gap-3 border border-slate-200">
                            <script>document.write('<i data-lucide="file-text" class="w-8 h-8 text-blue-600 flex-shrink-0"></i>');</script>
                            <div class="flex-1 min-w-0">
                                <p class="font-medium text-slate-900 truncate">Module_Guide.pdf</p>
                                <p class="text-xs text-slate-600">2.4 MB • PDF Document</p>
                            </div>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-lg flex items-center gap-3 border border-slate-200">
                            <script>document.write('<i data-lucide="file-text" class="w-8 h-8 text-purple-600 flex-shrink-0"></i>');</script>
                            <div class="flex-1 min-w-0">
                                <p class="font-medium text-slate-900 truncate">Worksheets.docx</p>
                                <p class="text-xs text-slate-600">1.8 MB • Word Document</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delete Button -->
                <div class="flex justify-end pt-4">
                    <form th:action="@{/content/delete/{id}(id=${selectedItem.id})}" method="post" onsubmit="return confirm('Are you sure you want to delete this content?');">
                        <input type="hidden" name="itemType" th:value="${selectedItem.type}" />
                        <button type="submit"
                            class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2">
                            <script>document.write('<i data-lucide="trash-2" class="w-4 h-4"></i>');</script>
                            Delete
                        </button>
                    </form>
                </div>
            </div>
        </div>


        <!-- --- Create/Edit Form Mode --- -->
        <div th:if="${isCreating or isEditing}" class="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
            <div class="flex items-start justify-between mb-4 border-b pb-4">
                <h2 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                    <span th:utext="${#strings.escapeXml(getTypeIconHtml(formData.type))}"></span>
                    <span th:class="${formData.typeColor}">
                        <span th:text="${isEditing ? 'Edit' : 'Create New'}"></span> 
                        <span th:text="${formData.type == 'module' ? 'Module' : (formData.type == 'forum' ? 'Forum Topic' : 'Resource')}"></span>
                    </span>
                </h2>
                <!-- Back/Cancel Button -->
                <a th:href="@{/content(selectedType=${formData.type})}" class="px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors">
                    <script>document.write('<i data-lucide="x" class="w-4 h-4"></i>');</script>
                </a>
            </div>

            <form th:action="@{/content/save}" th:object="${formData}" method="post">
                <input type="hidden" th:field="*{id}" />
                <input type="hidden" th:field="*{type}" />
                
                <div class="space-y-6">
                    <!-- Title -->
                    <div>
                        <label for="title" class="block text-sm font-medium text-slate-900 mb-2">Title <span class="text-red-600">*</span></label>
                        <input type="text" id="title" th:field="*{title}" required placeholder="Enter content title" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>

                    <!-- Description -->
                    <div>
                        <label for="description" class="block text-sm font-medium text-slate-900 mb-2">Description <span class="text-red-600">*</span></label>
                        <textarea id="description" th:field="*{description}" required placeholder="Enter content description" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- Category -->
                    <div>
                        <label for="category" class="block text-sm font-medium text-slate-900 mb-2">Category <span class="text-red-600">*</span></label>
                        <select id="category" th:field="*{category}" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select a category</option>
                            <option th:each="cat : ${categories.get(formData.type)}" th:value="${cat}" th:text="${cat}"></option>
                        </select>
                    </div>

                    <!-- Content -->
                    <div>
                        <label for="content" class="block text-sm font-medium text-slate-900 mb-2">Content</label>
                        <textarea id="content" th:field="*{content}" placeholder="Enter detailed content..." rows="8" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- Attachments (Simplified placeholder) -->
                    <div>
                        <label class="block text-sm font-medium text-slate-900 mb-2">Attachments</label>
                        <div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors cursor-pointer">
                            <script>document.write('<i data-lucide="upload" class="w-8 h-8 text-slate-400 mx-auto mb-2"></i>');</script>
                            <p class="text-sm text-slate-600">Click to upload or drag and drop</p>
                        </div>
                    </div>

                    <!-- Status -->
                    <div>
                        <label class="block text-sm font-medium text-slate-900 mb-2">Status</label>
                        <div class="flex gap-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" th:field="*{status}" value="draft" class="w-4 h-4 text-blue-600" />
                                <span class="ml-2 text-slate-700">Save as Draft</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" th:field="*{status}" value="published" class="w-4 h-4 text-blue-600" />
                                <span class="ml-2 text-slate-700">Publish Immediately</span>
                            </label>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-3 pt-4">
                        <a th:href="@{/content(selectedType=${formData.type})}" class="flex-1 py-3 px-4 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors text-center">
                            Cancel
                        </a>
                        <button type="submit"
                            class="flex-1 py-3 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                            <script>document.write('<i data-lucide="save" class="w-4 h-4"></i>');</script>
                            <span th:text="${isEditing ? 'Update' : 'Create'} + ' ' + (formData.type == 'module' ? 'Module' : (formData.type == 'forum' ? 'Forum Topic' : 'Resource'))"></span>
                        </button>
                    </div>
                </div>
            </form>
        </div>


        <!-- --- List View Mode --- -->
        <div th:unless="${isCreating or isEditing or isViewing}">
            <!-- Content Type Tabs -->
            <div class="flex items-center gap-2 mb-6">
                <a th:href="@{/content(selectedType='module')}"
                    th:classappend="${selectedType == 'module' ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}"
                    class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                    <script>document.write('<i data-lucide="book-open" class="w-4 h-4"></i>');</script>
                    Learning Modules
                </a>
                <a th:href="@{/content(selectedType='forum')}"
                    th:classappend="${selectedType == 'forum' ? 'bg-purple-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}"
                    class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                    <script>document.write('<i data-lucide="message-square" class="w-4 h-4"></i>');</script>
                    Forum Topics
                </a>
                <a th:href="@{/content(selectedType='resource')}"
                    th:classappend="${selectedType == 'resource' ? 'bg-green-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}"
                    class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                    <script>document.write('<i data-lucide="file-text" class="w-4 h-4"></i>');</script>
                    Resources
                </a>
                <a th:href="@{/content/create(selectedType=${selectedType})}"
                    class="ml-auto px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                    <script>document.write('<i data-lucide="plus" class="w-4 h-4"></i>');</script>
                    Create New
                </a>
            </div>

            <!-- Content List -->
            <div class="bg-white rounded-xl shadow-lg border border-slate-200">
                <div class="p-6">
                    <h2 class="text-xl font-bold text-slate-900 flex items-center gap-2 mb-4 border-b pb-4">
                        <span th:utext="${#strings.escapeXml(getTypeIconHtml(selectedType))}"></span>
                        <span th:class="${filteredContent.size() > 0 ? filteredContent.get(0).typeColor : 'text-slate-600'}">
                            <span th:text="${selectedType == 'module' ? 'Learning Modules' : (selectedType == 'forum' ? 'Forum Topics' : 'Resources')}"></span>
                        </span>
                        <span class="text-slate-600"> (<span th:text="${filteredContent.size()}"></span>)</span>
                    </h2>

                    <div th:if="${filteredContent.size() > 0}" class="space-y-3">
                        <div th:each="item : ${filteredContent}" class="p-4 border border-slate-200 rounded-lg hover:shadow-md transition-shadow">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <h3 class="font-semibold text-slate-900" th:text="${item.title}"></h3>
                                        <span th:class="${item.getStatusBadgeClass()}" class="inline-flex items-center rounded-full px-3 py-0.5 text-xs font-medium uppercase" th:text="${item.status}"></span>
                                        <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-0.5 text-xs font-medium text-slate-800" th:text="${item.category}"></span>
                                    </div>
                                    <p class="text-slate-600 text-sm mb-3" th:text="${item.description}"></p>
                                    <div class="flex items-center gap-4 text-xs text-slate-500">
                                        <span>Created by: <span th:text="${item.createdBy}"></span></span>
                                        <span>•</span>
                                        <span>Last modified: <span th:text="${item.lastModified}"></span></span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 ml-4">
                                    <a th:href="@{/content(viewId=${item.id}, selectedType=${item.type})}" 
                                       class="p-2 text-green-600 hover:bg-green-50 rounded-lg transition-colors" title="View">
                                        <script>document.write('<i data-lucide="eye" class="w-4 h-4"></i>');</script>
                                    </a>
                                    <a th:href="@{/content(editId=${item.id}, selectedType=${item.type})}" 
                                       class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Edit">
                                        <script>document.write('<i data-lucide="edit-2" class="w-4 h-4"></i>');</script>
                                    </a>
                                    <form th:action="@{/content/delete/{id}(id=${item.id})}" method="post" onsubmit="return confirm('Are you sure you want to delete this content?');">
                                        <input type="hidden" name="itemType" th:value="${item.type}" />
                                        <button type="submit" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Delete">
                                            <script>document.write('<i data-lucide="trash-2" class="w-4 h-4"></i>');</script>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div th:unless="${filteredContent.size() > 0}" class="text-center py-12">
                        <span th:utext="${#strings.escapeXml(getTypeIconHtml(selectedType))}" class="w-16 h-16 text-slate-300 mx-auto mb-4"></span>
                        <p class="text-slate-600 mt-4">No <span th:text="${selectedType}"></span>s created yet</p>
                        <a th:href="@{/content/create(selectedType=${selectedType})}"
                            class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors inline-block">
                            Create First <span th:text="${selectedType == 'module' ? 'Module' : (selectedType == 'forum' ? 'Forum Topic' : 'Resource')}"></span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Re-initialize Lucide Icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    </script>
</th:block>