<th:block th:fragment="sidebar(user, currentView)">

    <!-- JavaScript for Mobile Sidebar Toggle -->
    <script>
        function toggleSidebar(action) {
            const sidebar = document.getElementById('sidebar-aside');
            const overlay = document.getElementById('sidebar-overlay');

            if (sidebar && overlay) {
                if (action === 'open') {
                    sidebar.classList.remove('-translate-x-full');
                    sidebar.classList.add('translate-x-0');
                    overlay.classList.remove('hidden');
                } else {
                    sidebar.classList.remove('translate-x-0');
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                }
            }
        }
    </script>

    <!-- Overlay -->
    <div id="sidebar-overlay"
         class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden hidden"
         onclick="toggleSidebar('close')"></div>

    <!-- Sidebar -->
    <aside id="sidebar-aside"
           class="fixed lg:static inset-y-0 left-0 z-50 w-64 bg-white border-r flex flex-col
                  transform transition-transform duration-300 -translate-x-full lg:translate-x-0">

        <!-- Header -->
        <div class="p-6 border-b">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                    <script>
                        document.write('<i data-lucide="brain" class="w-6 h-6 text-white"></i>');
                    </script>
                </div>
                <div>
                    <h1 class="text-xl font-bold">Health Hub</h1>
                    <p class="text-sm text-slate-500"
                       sec:authentication="principal.authorities">Role</p>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 p-4 space-y-1">

            <!-- Dashboard (ALL) -->
            <a th:href="@{/dashboard}"
               th:classappend="${currentView == 'dashboard'} ? 'bg-blue-50 text-blue-600' : 'text-slate-600 hover:bg-slate-50'"
               class="flex items-center gap-3 px-4 py-3 rounded-lg">
                <script>document.write('<i data-lucide="home" class="w-5 h-5"></i>');</script>
                <span>Dashboard</span>
            </a>

            <!-- Learning Modules (STUDENT, FACULTY, COUNSELLOR) -->
            <a th:if="${#authorization.expression('hasRole(''STUDENT'')') 
                     or #authorization.expression('hasRole(''FACULTY'')')
                     or #authorization.expression('hasRole(''COUNSELLOR'')')}"
               th:href="@{/learning}"
               th:classappend="${currentView == 'learning'} ? 'bg-blue-50 text-blue-600' : 'text-slate-600 hover:bg-slate-50'"
               class="flex items-center gap-3 px-4 py-3 rounded-lg">
                <script>document.write('<i data-lucide="book-open" class="w-5 h-5"></i>');</script>
                <span>Learning Modules</span>
            </a>

            <!-- Module Management (COUNSELLOR, ADMINISTRATOR) -->
            <a th:if="${#authorization.expression('hasRole(''COUNSELLOR'')') 
                     or #authorization.expression('hasRole(''ADMINISTRATOR'')')}"
               th:href="@{/learning/manage/modules}"
               th:classappend="${currentView == 'module-management'} 
                    ? 'bg-blue-50 text-blue-600' 
                    : 'text-slate-600 hover:bg-slate-50'"
               class="flex items-center gap-3 px-4 py-3 rounded-lg">
                <script>
                    document.write('<i data-lucide="settings" class="w-5 h-5"></i>');
                </script>
                <span>Module Management</span>
            </a>

            <!-- AI Coach (STUDENT, COUNSELLOR) -->
            <a th:if="${#authorization.expression('hasRole(''STUDENT'')') 
                     or #authorization.expression('hasRole(''COUNSELLOR'')')}"
               th:href="@{/coach}"
               th:classappend="${currentView == 'coach'} ? 'bg-blue-50 text-blue-600' : 'text-slate-600 hover:bg-slate-50'"
               class="flex items-center gap-3 px-4 py-3 rounded-lg">
                <script>document.write('<i data-lucide="bot" class="w-5 h-5"></i>');</script>
                <span>AI Mental Coach</span>
            </a>

            <!-- Care Plan (STUDENT, COUNSELLOR) -->
            <a th:if="${#authorization.expression('hasRole(''STUDENT'')') 
                     or #authorization.expression('hasRole(''COUNSELLOR'')')}"
               th:href="@{/careplan}"
               th:classappend="${currentView == 'careplan'} ? 'bg-blue-50 text-blue-600' : 'text-slate-600 hover:bg-slate-50'"
               class="flex items-center gap-3 px-4 py-3 rounded-lg">
                <script>document.write('<i data-lucide="sparkles" class="w-5 h-5"></i>');</script>
                <span>Care Plan</span>
            </a>

            <!-- Peer Support (STUDENT, FACULTY) -->
            <a th:if="${#authorization.expression('hasRole(''STUDENT'')') 
                     or #authorization.expression('hasRole(''FACULTY'')')}"
               th:href="@{/forum}"
               th:classappend="${currentView == 'forum'} ? 'bg-blue-50 text-blue-600' : 'text-slate-600 hover:bg-slate-50'"
               class="flex items-center gap-3 px-4 py-3 rounded-lg">
                <script>document.write('<i data-lucide="users" class="w-5 h-5"></i>');</script>
                <span>Peer Support</span>
            </a>

            <!-- Self-Assessment (ALL) -->
            <a th:href="@{/assessment}"
               th:classappend="${currentView == 'assessment'} ? 'bg-blue-50 text-blue-600' : 'text-slate-600 hover:bg-slate-50'"
               class="flex items-center gap-3 px-4 py-3 rounded-lg">
                <script>document.write('<i data-lucide="activity" class="w-5 h-5"></i>');</script>
                <span>Self-Assessment</span>
            </a>

            <!-- Rewards (STUDENT) -->
            <a th:if="${#authorization.expression('hasRole(''STUDENT'')')}"
               th:href="@{/gamification}"
               th:classappend="${currentView == 'gamification'} ? 'bg-blue-50 text-blue-600' : 'text-slate-600 hover:bg-slate-50'"
               class="flex items-center gap-3 px-4 py-3 rounded-lg">
                <script>document.write('<i data-lucide="trophy" class="w-5 h-5"></i>');</script>
                <span>Rewards</span>
            </a>

            <!-- Counselling (STUDENT, COUNSELLOR) -->
            <a th:if="${#authorization.expression('hasRole(''STUDENT'')') 
                     or #authorization.expression('hasRole(''COUNSELLOR'')')}"
               th:href="@{/counselling}"
               th:classappend="${currentView == 'counselling'} ? 'bg-blue-50 text-blue-600' : 'text-slate-600 hover:bg-slate-50'"
               class="flex items-center gap-3 px-4 py-3 rounded-lg">
                <script>document.write('<i data-lucide="video" class="w-5 h-5"></i>');</script>
                <span>Counselling Session</span>
            </a>

            <!-- Analytics (COUNSELLOR, ADMIN) -->
            <a th:if="${#authorization.expression('hasRole(''COUNSELLOR'')') 
                     or #authorization.expression('hasRole(''ADMINISTRATOR'')')}"
               th:href="@{/analytics}"
               th:classappend="${currentView == 'analytics'} ? 'bg-blue-50 text-blue-600' : 'text-slate-600 hover:bg-slate-50'"
               class="flex items-center gap-3 px-4 py-3 rounded-lg">
                <script>document.write('<i data-lucide="trending-up" class="w-5 h-5"></i>');</script>
                <span>Student Analytics</span>
            </a>

            <!-- At-Risk Referral (FACULTY) -->
            <a th:if="${#authorization.expression('hasRole(''FACULTY'')')}"
               th:href="@{/referral}"
               th:classappend="${currentView == 'referral'} ? 'bg-blue-50 text-blue-600' : 'text-slate-600 hover:bg-slate-50'"
               class="flex items-center gap-3 px-4 py-3 rounded-lg">
               
            <!-- Content Management (Faculty, Admin) -->
            <a th:if="${#authorization.expression('hasRole(''COUNSELLOR'')') 
                     or #authorization.expression('hasRole(''ADMINISTRATOR'')')}"th:href="@{/forum-management}"
                th:classappend="${currentView == 'forum-management'} ? 'bg-blue-50 text-blue-600' : 'text-slate-600 hover:bg-slate-50'"
                class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors"
            >
                <script>document.write('<i data-lucide="file-edit" class="w-5 h-5"></i>');</script>
                <span>Forum Management</span>
            </a>
            
            <!-- At-Risk Referral (Faculty Only) -->
            <a th:if="${#authorization.expression('hasRole(''FACULTY'')')}" th:href="@{/referral}"
                th:classappend="${currentView == 'referral'} ? 'bg-blue-50 text-blue-600' : 'text-slate-600 hover:bg-slate-50'"
                class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors"
            >
                <script>document.write('<i data-lucide="alert-triangle" class="w-5 h-5"></i>');</script>
                <span>At-Risk Referral</span>
            </a>

        </nav>

        <!-- Footer -->
        <div class="p-4 border-t">
            <a th:href="@{/profile}"
               th:classappend="${currentView == 'profile'} ? 'bg-blue-50 text-blue-600' : 'text-slate-600 hover:bg-slate-50'"
               class="flex items-center gap-3 px-4 py-3 rounded-lg">
                <script>document.write('<i data-lucide="user" class="w-5 h-5"></i>');</script>
                <span>Profile</span>
            </a>

            <form th:action="@{/logout}" method="post">
                <button type="submit"
                        class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-600 hover:bg-slate-50">
                    <script>document.write('<i data-lucide="log-out" class="w-5 h-5"></i>');</script>
                    <span>Logout</span>
                </button>
            </form>
        </div>
    </aside>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
    </script>

</th:block>
