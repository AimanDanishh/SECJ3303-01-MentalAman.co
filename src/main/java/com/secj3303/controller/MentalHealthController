package com.example.controller;

import com.example.model.User;
import com.example.service.AuthenticationService;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import jakarta.servlet.http.HttpSession;
import java.util.Optional;

@Controller
public class MentalHealthController {

    private final AuthenticationService authenticationService;
    private static final String USER_SESSION_KEY = "currentUser";

    // Inject the new service
    public MentalHealthController(AuthenticationService authenticationService) {
        this.authenticationService = authenticationService;
    }

    // --- Authentication Handlers ---

    @GetMapping("/")
    public String index(HttpSession session) {
        // Delegate check to service
        if (authenticationService.getAuthenticatedUser(session) != null) {
            return "redirect:/dashboard";
        }
        return "login";
    }

    @PostMapping("/login")
    public String handleLogin(@RequestParam String email, @RequestParam String password,
                              @RequestParam String role, HttpSession session, RedirectAttributes redirect) {
        
        // Delegate authentication logic to the service layer
        Optional<String> error = authenticationService.authenticateAndSetupSession(email, password, role, session);

        if (error.isPresent()) {
            redirect.addFlashAttribute("error", error.get());
            return "redirect:/";
        }
        
        return "redirect:/dashboard";
    }

    @GetMapping("/logout")
    public String handleLogout(HttpSession session) {
        session.invalidate();
        return "redirect:/";
    }

    // --- View Controllers (The rest of the application entry points) ---

    // A utility method to ensure the user is logged in before accessing any view
    private String checkAuth(HttpSession session, Model model, String viewName) {
        User user = authenticationService.getAuthenticatedUser(session);
        if (user == null) {
            return "redirect:/"; // Redirect to login
        }
        model.addAttribute("user", user);
        model.addAttribute("currentView", viewName);
        return "app-layout"; // Always return the main layout
    }

    @GetMapping("/dashboard")
    public String dashboard(HttpSession session, Model model) {
        return checkAuth(session, model, "dashboard");
    }

    @GetMapping("/learning")
    public String learning(HttpSession session, Model model) {
        return checkAuth(session, model, "learning");
    }

    @GetMapping("/coach")
    public String coach(HttpSession session, Model model) {
        return checkAuth(session, model, "coach");
    }
    
    @GetMapping("/profile")
    public String profile(HttpSession session, Model model) {
        return checkAuth(session, model, "profile");
    }
    
    // Placeholder mappings for other views...
    @GetMapping("/admin")
    public String admin(HttpSession session, Model model) {
        return checkAuth(session, model, "admin");
    }
}