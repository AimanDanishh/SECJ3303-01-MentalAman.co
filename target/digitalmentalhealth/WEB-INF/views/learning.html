<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
</head>
<body>

<th:block th:fragment="content(
    modules,
    completedCount,
    inProgressCount,
    totalModules,
    selectedModule,
    selectedLesson,
    showQuiz,
    quizScore,
    achievement,
    user
)">
    <div class="p-8">

        <!-- ================= HEADER ================= -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-slate-900 mb-2">Learning Modules</h1>
            <p class="text-slate-600">Access comprehensive mental health literacy content</p>
        </div>

        <!-- ================= PROGRESS OVERVIEW ================= -->
        <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div>
                    <p class="text-slate-600 mb-2">Total Modules</p>
                    <p class="text-3xl font-bold" th:text="${totalModules}"></p>
                </div>
                <div>
                    <p class="text-slate-600 mb-2">Completed</p>
                    <p class="text-3xl font-bold text-green-600" th:text="${completedCount}"></p>
                </div>
                <div>
                    <p class="text-slate-600 mb-2">In Progress</p>
                    <p class="text-3xl font-bold text-blue-600" th:text="${inProgressCount}"></p>
                </div>
                <div>
                    <p class="text-slate-600 mb-2">Total Time</p>
                    <p class="text-3xl font-bold">5.5 Hours</p>
                </div>
            </div>
        </div>

        <!-- ================= MODULE GRID ================= -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">

            <div th:each="module : ${modules}">
                <!-- ENTIRE CARD IS THE LINK -->
                <a th:href="${module.locked} ? '#' : @{/learning/module(moduleId=${module.id})}"
                   th:classappend="${module.locked} ? 'opacity-50 pointer-events-none' : 'hover:shadow-lg cursor-pointer'"
                   class="block bg-white rounded-xl shadow-md border border-slate-200 transition-shadow">

                    <div class="p-6">

                        <!-- TAG + ICON -->
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm bg-slate-100 px-3 py-1 rounded-full"
                                  th:text="${module.category}"></span>

                            <span th:if="${module.quizPassed}" class="text-yellow-500">üèÜ</span>
                            <span th:if="${module.locked}" class="text-slate-400">üîí</span>
                        </div>

                        <!-- TITLE -->
                        <h3 class="text-xl font-bold mb-2" th:text="${module.title}"></h3>
                        <p class="text-slate-600 mb-4" th:text="${module.description}"></p>

                        <!-- PROGRESS -->
                        <div th:if="${module.progress > 0}" class="mb-4">
                            <div class="flex justify-between text-sm mb-1">
                                <span>Progress</span>
                                <span th:text="${module.progress + '%'}"></span>
                            </div>
                            <div class="w-full bg-slate-200 h-2 rounded-full">
                                <div class="bg-blue-600 h-2 rounded-full"
                                     th:style="'width:' + ${module.progress} + '%'"></div>
                            </div>
                        </div>

                        <!-- META -->
                        <div class="flex justify-between text-sm text-slate-600 mb-4">
                            <span th:text="${module.duration}"></span>
                            <span th:text="${module.lessons.size() + ' lessons'}"></span>
                        </div>

                        <!-- CTA (NOT A BUTTON) -->
                        <div th:if="${!module.locked}"
                             class="w-full py-2 bg-blue-600 text-white rounded-lg text-center
                                    hover:bg-blue-700 transition">
                            <span th:text="${module.progress > 0 ? 'Continue Learning' : 'Start Module'}"></span>
                        </div>

                        <div th:if="${module.locked}"
                             class="w-full py-2 bg-slate-200 text-slate-500 rounded-lg text-center">
                            Locked
                        </div>

                    </div>
                </a>
            </div>
        </div>

        <!-- ================= MODULE MODAL ================= -->
        <div th:if="${selectedModule != null}"
             class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40">

            <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">

                <!-- HEADER -->
                <div class="p-6 border-b flex justify-between">
                    <div>
                        <h2 class="text-2xl font-bold" th:text="${selectedModule.title}"></h2>
                        <p class="text-slate-600" th:text="${selectedModule.description}"></p>
                    </div>
                    <a th:href="@{/learning}" class="text-xl">‚úñ</a>
                </div>

                <!-- BODY -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">

                    <!-- LESSON LIST -->
                    <div>
                        <h3 class="font-semibold mb-4">Lessons</h3>

                        <a th:each="lesson : ${selectedModule.lessons}"
                           th:href="@{/learning/module(moduleId=${selectedModule.id}, lessonId=${lesson.id})}"
                           class="block p-3 mb-2 rounded-lg bg-slate-50 hover:bg-slate-100">

                            <div class="flex justify-between">
                                <span th:text="${lesson.title}"></span>
                                <span th:if="${lesson.completed}">‚úî</span>
                            </div>

                            <small class="text-slate-600" th:text="${lesson.duration}"></small>
                        </a>

                        <a th:if="${selectedModule.quiz.size() > 0}"
                           th:href="@{/learning/module(moduleId=${selectedModule.id}, showQuiz=true)}"
                           class="block p-3 bg-purple-100 rounded-lg text-purple-800">
                            üìù Module Quiz
                        </a>
                    </div>

                    <!-- CONTENT -->
                    <div class="lg:col-span-2">

                        <!-- LESSON -->
                        <div th:if="${!showQuiz and selectedLesson != null}">
                            <h3 class="text-xl font-bold mb-4"
                                th:text="${selectedLesson.title}"></h3>

                            <iframe th:if="${selectedLesson.type == 'video'}"
                                    th:src="${selectedLesson.url}"
                                    class="w-full aspect-video rounded-lg mb-4"></iframe>

                            <img th:if="${selectedLesson.type == 'infographic'}"
                                 th:src="${selectedLesson.url}"
                                 class="w-full rounded-lg mb-4"/>

                            <form th:action="@{/learning/complete-lesson}" method="post">
                                <input type="hidden" name="moduleId" th:value="${selectedModule.id}">
                                <button type="submit"
                                        class="w-full py-3 bg-blue-600 text-white rounded-lg">
                                    Mark as Complete
                                </button>
                            </form>
                        </div>

                        <!-- QUIZ -->
                        <div th:if="${showQuiz}">
                            <h3 class="text-xl font-bold mb-4">Module Quiz</h3>
                            
                            <div th:if="${selectedModule.quiz == null or selectedModule.quiz.isEmpty()}">
                                <p class="text-slate-600 mb-4">No quiz available for this module.</p>
                            </div>
                            
                            <form th:if="${selectedModule.quiz != null and !selectedModule.quiz.isEmpty()}"
                                th:action="@{/learning/submit-quiz}" method="post">
                                <input type="hidden" name="moduleId" th:value="${selectedModule.id}">
                                <div th:each="q, iter : ${selectedModule.quiz}" class="mb-6">
                                    <p class="font-semibold mb-2" th:text="${iter.index + 1 + '. ' + q.question}"></p>
                                    <div th:each="opt, s : ${q.options}" class="ml-4">
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio"
                                                th:name="'question-' + ${q.id}"
                                                th:value="${s.index}"
                                                required
                                                class="mr-2">
                                            <span th:text="${opt}"></span>
                                        </label>
                                    </div>
                                </div>
                                <button class="w-full py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                                    Submit Quiz
                                </button>
                            </form>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>

    </div>
</th:block>

</body>
</html>
