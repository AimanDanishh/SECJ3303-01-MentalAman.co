<th:block th:fragment="content(apiKeys, isAddingKey, newKeyData, showSuccess, successMessage, showError, errorMessage)">
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>if (typeof lucide !== 'undefined') lucide.createIcons();</script>

    <div class="p-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-slate-900 mb-2 flex items-center gap-2">
                <script>document.write('<i data-lucide="key" class="w-8 h-8 text-blue-600"></i>');</script>
                API Settings
            </h1>
            <p class="text-slate-600">Manage API keys and external service integrations</p>
        </div>

        <!-- Success Alert (using flash attributes) -->
        <div th:if="${successMessage}" class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg flex items-start gap-3">
            <script>document.write('<i data-lucide="check-circle" class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"></i>');</script>
            <div class="flex-1">
                <p class="font-medium text-green-900 mb-1">Success</p>
                <p class="text-green-700 text-sm" th:text="${successMessage}"></p>
            </div>
            <!-- Client-side dismissal is omitted since flash attributes naturally disappear on refresh/redirect -->
        </div>

        <!-- Error Alert (using flash attributes) -->
        <div th:if="${errorMessage}" class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg flex items-start gap-3">
            <script>document.write('<i data-lucide="alert-circle" class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5"></i>');</script>
            <div class="flex-1">
                <p class="font-medium text-red-900 mb-1">Error</p>
                <p class="text-red-700 text-sm" th:text="${errorMessage}"></p>
            </div>
        </div>

        <!-- Security Notice -->
        <div class="bg-blue-50 border border-blue-200 rounded-xl shadow-md mb-6 p-6">
            <div class="flex items-start gap-3">
                <script>document.write('<i data-lucide="alert-circle" class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"></i>');</script>
                <div>
                    <p class="font-medium text-blue-900 mb-1">Security Notice</p>
                    <p class="text-blue-800 text-sm">
                        API keys are sensitive credentials. Never share them publicly or commit them to version control. 
                        Store them securely and rotate them regularly. If a key is compromised, regenerate it immediately.
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Add New Key Button (Shown only if not currently adding) -->
        <div th:unless="${isAddingKey}" class="mb-6">
            <a th:href="@{/api/add}"
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center w-fit gap-2">
                <script>document.write('<i data-lucide="plus" class="w-4 h-4"></i>');</script>
                Add New API Key
            </a>
        </div>

        <!-- Add New Key Form (Shown only if isAddingKey is true) -->
        <div th:if="${isAddingKey}" class="bg-white rounded-xl shadow-lg border border-slate-200 mb-6">
            <div class="p-6">
                <h2 class="text-xl font-bold text-slate-900 flex items-center gap-2 mb-4 border-b pb-4">
                    <script>document.write('<i data-lucide="plus" class="w-5 h-5 text-blue-600"></i>');</script>
                    Add New API Key
                </h2>
                
                <form th:action="@{/api/add}" th:object="${newKeyData}" method="post">
                    <div class="space-y-4">
                        <div>
                            <label for="keyName" class="block text-sm font-medium text-slate-900 mb-2">Key Name <span class="text-red-600">*</span></label>
                            <input type="text" id="keyName" th:field="*{name}" required placeholder="e.g., Payment Gateway API" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>

                        <div>
                            <label for="service" class="block text-sm font-medium text-slate-900 mb-2">Service Provider <span class="text-red-600">*</span></label>
                            <input type="text" id="service" th:field="*{service}" required placeholder="e.g., Stripe, AWS, Firebase" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>

                        <div>
                            <label for="apiKey" class="block text-sm font-medium text-slate-900 mb-2">API Key <span class="text-red-600">*</span></label>
                            <!-- Note: type="text" is used here to allow the key value to be pre-populated on form error redirect -->
                            <input type="text" id="apiKey" th:field="*{key}" required placeholder="Paste your API key here" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono" />
                        </div>

                        <div class="flex gap-3 pt-4">
                            <a th:href="@{/api}" class="flex-1 py-2 px-4 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors text-center">
                                Cancel
                            </a>
                            <button type="submit" class="flex-1 py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                                <script>document.write('<i data-lucide="save" class="w-4 h-4"></i>');</script>
                                Add API Key
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- API Keys List -->
        <div class="bg-white rounded-xl shadow-lg border border-slate-200">
            <div class="p-6">
                <h2 class="text-xl font-bold text-slate-900 flex items-center gap-2 mb-4 border-b pb-4">
                    <script>document.write('<i data-lucide="key" class="w-5 h-5 text-blue-600"></i>');</script>
                    Configured API Keys (<span th:text="${apiKeys.size()}"></span>)
                </h2>
                
                <div class="space-y-4">
                    <div th:each="apiKey : ${apiKeys}" class="p-5 border border-slate-200 rounded-lg hover:shadow-md transition-shadow">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <h3 class="font-semibold text-slate-900" th:text="${apiKey.name}"></h3>
                                    <span th:classappend="${apiKey.isActive()} ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                          class="inline-flex items-center rounded-full px-3 py-0.5 text-xs font-medium uppercase"
                                          th:text="${apiKey.status}">
                                    </span>
                                </div>
                                <p class="text-sm text-slate-600 mb-3" th:text="${apiKey.service}"></p>
                                
                                <div class="flex items-center gap-3 mb-3">
                                    <!-- Key Display Area -->
                                    <code th:id="'key-' + ${apiKey.id}" class="flex-1 px-3 py-2 bg-slate-100 rounded font-mono text-sm text-slate-900">
                                        <!-- Initial masked value -->
                                        <span th:text="${apiKey.getMaskedKey()}"></span>
                                    </code>
                                    
                                    <!-- Toggle Visibility Button -->
                                    <button
                                        th:onclick="'toggleKeyVisibility(' + ${apiKey.id} + ', \'' + ${apiKey.key} + '\', \'' + ${apiKey.getMaskedKey()} + '\')'"
                                        th:id="'toggle-' + ${apiKey.id}"
                                        class="p-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
                                        title="Show key"
                                    >
                                        <script>document.write('<i data-lucide="eye" class="w-4 h-4"></i>');</script>
                                    </button>
                                    
                                    <!-- Copy Button -->
                                    <button
                                        th:onclick="'handleCopyKey(' + ${apiKey.id} + ', \'' + ${apiKey.key} + '\')'"
                                        th:id="'copy-' + ${apiKey.id}"
                                        class="p-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
                                        title="Copy key"
                                    >
                                        <script>document.write('<i data-lucide="copy" class="w-4 h-4"></i>');</script>
                                    </button>
                                </div>

                                <div class="flex items-center gap-4 text-xs text-slate-500">
                                    <span>Created: <span th:text="${apiKey.createdDate}"></span></span>
                                    <span>â€¢</span>
                                    <span>Last used: <span th:text="${apiKey.lastUsed}"></span></span>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center gap-2 pt-3 border-t border-slate-200">
                            <!-- Toggle Status Form -->
                            <form th:action="@{/api/toggle/{id}(id=${apiKey.id})}" method="post">
                                <button type="submit"
                                        th:classappend="${apiKey.isActive()} ? 'bg-red-50 text-red-600 hover:bg-red-100' : 'bg-green-50 text-green-600 hover:bg-green-100'"
                                        class="px-3 py-1.5 rounded-lg text-sm transition-colors"
                                >
                                    <span th:text="${apiKey.isActive()} ? 'Deactivate' : 'Activate'"></span>
                                </button>
                            </form>
                            
                            <!-- Regenerate Form -->
                            <form th:action="@{/api/regenerate/{id}(id=${apiKey.id})}" method="post" id="regenerate-form-[[${apiKey.id}]]">
                                <button type="submit"
                                        onclick="return confirm('Are you sure you want to REGENERATE the API key for \'[[${apiKey.name}]]\'? The old key will immediately stop working.');"
                                        class="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors text-sm flex items-center gap-1">
                                    <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                                    Regenerate
                                </button>
                            </form>

                            <!-- Delete Form -->
                            <form th:action="@{/api/delete/{id}(id=${apiKey.id})}" method="post" id="delete-form-[[${apiKey.id}]]">
                                <button type="submit"
                                        onclick="return confirm('Are you sure you want to DELETE the API key for \'[[${apiKey.name}]]\'? This action cannot be undone.');"
                                        class="px-3 py-1.5 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors text-sm flex items-center gap-1">
                                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                                    Delete
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Integration Guide -->
        <div class="bg-white rounded-xl shadow-md border border-slate-200 mt-6">
            <div class="p-6">
                <h3 class="text-lg font-bold text-slate-900 mb-4 border-b pb-3">Integration Guide</h3>
                <div class="space-y-4 text-sm">
                    <div>
                        <p class="font-medium text-slate-900 mb-2">Supported Services:</p>
                        <ul class="list-disc list-inside space-y-1 text-slate-700">
                            <li><strong>OpenAI GPT-4:</strong> Powers the AI Mental Health Coach</li>
                            <li><strong>SendGrid:</strong> Email notifications and alerts</li>
                            <li><strong>Zoom API:</strong> Video counseling sessions</li>
                            <li><strong>Twilio:</strong> SMS alerts and reminders</li>
                            <li><strong>Google Analytics:</strong> Platform usage analytics</li>
                        </ul>
                    </div>
                    
                    <div>
                        <p class="font-medium text-slate-900 mb-2">Best Practices:</p>
                        <ul class="list-disc list-inside space-y-1 text-slate-700">
                            <li>Rotate API keys every 90 days</li>
                            <li>Use environment variables to store keys</li>
                            <li>Monitor key usage for suspicious activity</li>
                            <li>Deactivate unused keys immediately</li>
                            <li>Set up rate limiting for each API</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const copiedKeyMap = {}; // Tracks which key is copied
        
        // --- Client-Side Functions to manage UI state ---

        // Replicates toggleKeyVisibility and manages UI icon/key text
        function toggleKeyVisibility(keyId, fullKey, maskedKey) {
            const keyElement = document.getElementById(`key-${keyId}`).querySelector('span');
            const toggleButton = document.getElementById(`toggle-${keyId}`);
            
            const isVisible = keyElement.textContent === fullKey;

            if (isVisible) {
                keyElement.textContent = maskedKey;
                toggleButton.innerHTML = '<i data-lucide="eye" class="w-4 h-4"></i>';
                toggleButton.title = 'Show key';
            } else {
                keyElement.textContent = fullKey;
                toggleButton.innerHTML = '<i data-lucide="eye-off" class="w-4 h-4"></i>';
                toggleButton.title = 'Hide key';
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // Replicates handleCopyKey
        function handleCopyKey(keyId, key) {
            // Use execCommand for broader compatibility in sandboxed environments
            const tempInput = document.createElement('textarea');
            tempInput.value = key;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);

            // Update button icon to show 'Check'
            const copyButton = document.getElementById(`copy-${keyId}`);
            copyButton.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-green-600"></i>';
            if (typeof lucide !== 'undefined') lucide.createIcons();

            // Reset icon after 2 seconds
            clearTimeout(copiedKeyMap[keyId]);
            copiedKeyMap[keyId] = setTimeout(() => {
                copyButton.innerHTML = '<i data-lucide="copy" class="w-4 h-4"></i>';
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }, 2000);
        }
        
        // Re-initialize Lucide Icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    </script>
</th:block>