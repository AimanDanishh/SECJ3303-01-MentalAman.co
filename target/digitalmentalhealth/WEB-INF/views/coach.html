<th:block th:fragment="content(user)">
    <div class="p-6 lg:p-8 w-full max-w-[1600px] mx-auto min-h-screen">
        
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-slate-900 mb-2 flex items-center gap-3">
                <i data-lucide="sparkles" class="w-8 h-8 text-purple-600"></i>
                AI Mental Health Coach
            </h1>
            <p class="text-slate-600">Get instant support and guidance for your mental wellbeing</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
            
            <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col h-[750px] overflow-hidden">
                
                <div class="p-4 border-b flex justify-between items-center bg-white sticky top-0 z-10">
                    <div class="flex items-center gap-2">
                        <i data-lucide="bot" class="w-5 h-5 text-purple-600"></i>
                        <span class="font-semibold text-slate-700">Chat with AI Coach</span>
                    </div>
                    <form th:action="@{/coach/clear}" method="post">
                        <button type="submit" class="text-sm text-slate-500 hover:text-slate-800 flex items-center gap-1">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i> Clear Chat
                        </button>
                    </form>
                </div>

                <div id="messages-container" class="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-50/30">
                    <div th:each="message : ${messages}"
                         th:classappend="${message.role == 'user'} ? 'flex-row-reverse' : ''"
                         class="flex items-start gap-4">
                        
                        <div th:classappend="${message.role == 'ai'} ? 'bg-purple-100' : 'bg-blue-100'"
                             class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 shadow-sm border border-white">
                            <i th:if="${message.role == 'ai'}" data-lucide="bot" class="w-5 h-5 text-purple-600"></i>
                            <i th:if="${message.role == 'user'}" data-lucide="user" class="w-5 h-5 text-blue-600"></i>
                        </div>
                        
                        <div th:classappend="${message.role == 'user'} ? 'text-right' : ''" class="flex-1 max-w-[85%]">
                            <div th:classappend="${message.role == 'ai'} ? 'bg-white text-slate-700 border border-slate-100' : 'bg-blue-600 text-white shadow-md'"
                                 class="inline-block p-4 rounded-2xl text-sm text-left shadow-sm">
                                <p class="whitespace-pre-line" th:text="${message.text}"></p>
                            </div>
                            <p class="text-[10px] text-slate-400 mt-2 uppercase font-medium tracking-tight" 
                               th:text="${message.formattedTime != null ? message.formattedTime : '3:19 PM'}"></p>
                        </div>
                    </div>

                    <div id="typing-indicator" class="hidden flex items-start gap-4">
                        <div class="bg-purple-100 w-10 h-10 rounded-full flex items-center justify-center">
                            <i data-lucide="bot" class="w-5 h-5 text-purple-600"></i>
                        </div>
                        <div class="bg-slate-100 p-4 rounded-2xl shadow-sm">
                            <div class="flex gap-1">
                                <span class="w-1.5 h-1.5 bg-purple-400 rounded-full animate-bounce"></span>
                                <span class="w-1.5 h-1.5 bg-purple-400 rounded-full animate-bounce [animation-delay:0.2s]"></span>
                                <span class="w-1.5 h-1.5 bg-purple-400 rounded-full animate-bounce [animation-delay:0.4s]"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-6 border-t bg-white">
                    <form th:action="@{/coach/send}" method="post" id="chat-form" class="flex gap-4 items-center">
                        <div class="relative flex-1">
                            <textarea id="input-message" name="inputMessage" rows="1" required
                                      placeholder="Type your message here... (Press Enter to send)"
                                      class="w-full px-5 py-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none text-sm resize-none"></textarea>
                        </div>
                        <button type="submit" id="send-btn" class="bg-slate-100 hover:bg-purple-600 hover:text-white text-slate-500 p-4 rounded-xl transition-all shadow-sm group">
                            <i data-lucide="send" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        </button>
                    </form>
                </div>
            </div>

            <div class="space-y-6">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <h3 class="font-bold text-slate-800 mb-5 text-xs uppercase tracking-widest">Quick Topics</h3>
                    <div class="space-y-2">
                        <button type="button" onclick="fillInput('ðŸ“š Exam Stress')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-slate-100 rounded-xl text-sm flex items-center gap-3 transition-all">
                            <span>ðŸ“š</span> Exam Stress
                        </button>
                        <button type="button" onclick="fillInput('ðŸ˜° Anxiety')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-slate-100 rounded-xl text-sm flex items-center gap-3 transition-all">
                            <span>ðŸ˜°</span> Anxiety
                        </button>
                        <button type="button" onclick="fillInput('ðŸ˜´ Sleep Issues')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-slate-100 rounded-xl text-sm flex items-center gap-3 transition-all">
                            <span>ðŸ˜´</span> Sleep Issues
                        </button>
                        <button type="button" onclick="fillInput('ðŸ§˜ Stress Management')" class="w-full text-left px-4 py-3 bg-slate-50 hover:bg-slate-100 rounded-xl text-sm flex items-center gap-3 transition-all">
                            <span>ðŸ§˜</span> Stress Management
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <h3 class="font-bold text-slate-800 mb-5 text-sm">How AI Coach Works</h3>
                    <div class="space-y-4 text-sm text-slate-600">
                        <div class="flex items-start gap-3">
                            <i data-lucide="check-circle" class="w-5 h-5 text-green-500 mt-0.5"></i>
                            <p>24/7 availability for instant support</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <i data-lucide="check-circle" class="w-5 h-5 text-green-500 mt-0.5"></i>
                            <p>Confidential and judgment-free</p>
                        </div>
                    </div>
                    <hr class="my-6 border-slate-100">
                    <div class="flex items-center gap-2 mb-3 text-orange-600 font-bold text-sm">
                        <i data-lucide="alert-circle" class="w-5 h-5"></i>
                        <span>Important Note</span>
                    </div>
                    <p class="text-xs text-slate-500 leading-relaxed mb-6">
                        The AI Coach provides support but is not a replacement for professional care.
                    </p>
                    <a href="/counselling" class="block w-full py-4 bg-[#8b5cf6] hover:bg-[#7c3aed] text-white text-center rounded-xl text-sm font-bold transition-all shadow-md">
                        Book Counselor Session
                    </a>
                </div>
            </div>

        </div>
    </div>

    <script th:inline="javascript">
        function fillInput(val) {
            document.getElementById('input-message').value = "I want to talk about " + val;
            document.getElementById('input-message').focus();
        }

        document.getElementById('chat-form').addEventListener('submit', function() {
            document.getElementById('typing-indicator').classList.remove('hidden');
            const container = document.getElementById('messages-container');
            container.scrollTop = container.scrollHeight;
        });

        (function() {
            const container = document.getElementById('messages-container');
            if(container) container.scrollTop = container.scrollHeight;
            if(window.lucide) lucide.createIcons();
        })();
    </script>
</th:block>